{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Products - Blueprint Apparel</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'admin-favicon.svg' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    {% include "admin/partials/dark_mode_styles.html" %}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .nav-links {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1rem 2rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .nav-link {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .top-bar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem 0;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
      margin-bottom: 2rem;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .btn-primary {
      background: white;
      color: #667eea;
      padding: 0.875rem 1.75rem;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .main-content {
      padding: 0 2rem 2rem 2rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
      margin-top: -4rem;
      position: relative;
      z-index: 10;
    }

    .stat-box {
      background: white;
      border-radius: 16px;
      padding: 1.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      text-align: center;
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }

    .stat-box:hover::before {
      opacity: 1;
    }

    .stat-box h4 {
      color: #64748b;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.75rem;
    }

    .stat-box .number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.25rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .stat-box .icon {
      font-size: 1.75rem;
      margin-bottom: 0.75rem;
      color: #667eea;
    }

    .products-section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e2e8f0;
    }

    .section-title {
      color: #1e293b;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 1.5rem;
      position: relative;
      padding-left: 1rem;
    }

    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 28px;
      background: linear-gradient(180deg, #667eea, #764ba2);
      border-radius: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f8fafc;
      color: #64748b;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 1rem;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
    }

    /* Variants table in modal */
    .variants-modal-table th {
      background: #f8fafc !important;
      color: #475569 !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.05em !important;
      padding: 0.875rem 1rem !important;
      border-bottom: 2px solid #e2e8f0 !important;
    }

    td {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }

    tbody tr {
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .product-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 0.9375rem;
    }

    .product-slug {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .product-row {
      transition: background-color 0.15s ease;
    }

    .product-row:hover {
      background-color: #f8fafc;
    }

    .product-row:hover .expand-icon {
      color: #667eea;
    }

    .variants-row {
      border-left: 3px solid #667eea;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge.active {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    .badge.inactive {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
    }

    .badge.low-stock {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
    }

    .badge.out-of-stock {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
    }

    .price-input {
      border: 1px solid #e2e8f0;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.875rem;
      width: 100px;
      transition: all 0.2s;
    }

    .price-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .price-preset-btn {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 0.25rem 0.625rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .price-preset-btn:hover {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .price-preset-btn:active {
      transform: scale(0.95);
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
    }

    .toggle-active {
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-active:hover {
      transform: scale(1.05);
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 2rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      color: #1e293b;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #f1f5f9;
      color: #1e293b;
    }

    .modal-body {
      padding: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      color: #334155;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      border: 1px solid #e2e8f0;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-footer {
      padding: 1.5rem 2rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      .quick-stats {
        grid-template-columns: 1fr 1fr;
        margin-top: -3rem;
      }
      .modal-content {
        max-width: 100%;
        margin: 1rem;
      }
    }
  </style>
  {% include "admin/partials/dark_mode_apply.html" %}
</head>
<body>
  <div class="nav-links">
    <a href="{% url 'admin_home' %}" class="nav-link">‚Üê Back</a>
  </div>

  <div class="top-bar">
    <div class="container">
      <div class="header">
        <h1>Products</h1>
        <div style="display: flex; gap: 0.75rem;">
          <a href="{% url 'admin_product_wizard' %}" class="btn-primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-wand-magic-sparkles"></i> Create Product
          </a>
          <button onclick="openAddProductPopup()" class="btn-primary" style="background: white; color: #10b981; border: 2px solid #10b981;">+ Quick Add</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-box"></i></div>
        <h4>Core Products</h4>
        <div class="number">{{ total_products }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Unique product types</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-check-circle"></i></div>
        <h4>Active Products</h4>
        <div class="number">{{ active_products }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-barcode"></i></div>
        <h4>SKUs</h4>
        <div class="number">{{ total_variants }}</div>
        <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Total variants</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-warehouse"></i></div>
        <h4>Total Stock</h4>
        <div class="number">{{ total_stock }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-exclamation-triangle"></i></div>
        <h4>Low Stock</h4>
        <div class="number">{{ low_stock_count }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-ban"></i></div>
        <h4>Out of Stock</h4>
        <div class="number">{{ out_of_stock_count }}</div>
      </div>
    </div>

    <!-- Products Table -->
    <div class="products-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
          <h2 class="section-title" style="margin-bottom: 0.5rem;">Product Catalog</h2>
          <p style="color: #64748b; font-size: 0.875rem; padding-left: 1rem;">
            Showing <strong>{{ total_products }} core products</strong>. Each product may have multiple size/color combinations.
          </p>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <label style="font-size: 0.875rem; color: #64748b;">Sort by:</label>
          <select id="sortSelect" onchange="applySort(this.value)" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.875rem; background: white; cursor: pointer;">
            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest First</option>
            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
            <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Category</option>
            <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
          </select>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Product Name</th>
            <th>Category</th>
            <th>Base Price</th>
            <th>Base Cost</th>
            <th>Total Stock</th>
            <th>SKUs</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr class="product-row" data-product-id="{{ product.id }}" onclick="toggleProductExpand(this, event)" style="cursor: pointer;">
            <td>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <i class="fa-solid fa-chevron-right expand-icon" style="color: #94a3b8; font-size: 0.75rem; transition: transform 0.2s;"></i>
                <div>
                  <div class="product-name">{{ product.name }}</div>
                  <div class="product-slug">/{{ product.slug }}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #4338ca;">
                {{ product.category|default:"Uncategorized" }}
              </span>
            </td>
            <td>
              <span style="font-weight: 600; color: #0f172a;">${{ product.base_price }}</span>
            </td>
            <td>
              <span style="color: #64748b;">${{ product.base_cost|default:0 }}</span>
            </td>
            <td>
              {% if product.total_stock == 0 %}
                <span class="badge out-of-stock">
                  <i class="fa-solid fa-ban"></i>
                  Out of Stock
                </span>
              {% elif product.total_stock < 10 %}
                <span class="badge low-stock">
                  <i class="fa-solid fa-exclamation-triangle"></i>
                  {{ product.total_stock }} units
                </span>
              {% else %}
                <strong>{{ product.total_stock }}</strong> units
              {% endif %}
            </td>
            <td>
              <strong>{{ product.variant_count }}</strong> total
              <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                {{ product.active_variants }} active
              </div>
            </td>
            <td>
              <span
                class="badge {% if product.is_active %}active{% else %}inactive{% endif %} toggle-active"
                data-product-id="{{ product.id }}"
                onclick="event.stopPropagation(); toggleActive(this)"
              >
                <i class="fa-solid fa-{% if product.is_active %}check-circle{% else %}times-circle{% endif %}"></i>
                {% if product.is_active %}Active{% else %}Inactive{% endif %}
              </span>
            </td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                <button
                  onclick="event.stopPropagation(); openEditModal({{ product.id }}, '{{ product.name|escapejs }}', '{{ product.slug }}', '{{ product.category_slug|escapejs }}', '{{ product.description|escapejs }}', '{{ product.base_price }}', '{{ product.base_cost|default:0 }}', {{ product.featured|lower }}, {{ product.available_for_purchase|lower }}, {{ product.images|safe|default:"[]" }})"
                  class="btn btn-secondary btn-sm"
                >
                  <i class="fa-solid fa-edit"></i>
                  Edit
                </button>
                <button
                  onclick="event.stopPropagation(); deleteProduct({{ product.id }}, '{{ product.name|escapejs }}')"
                  class="btn btn-sm"
                  style="background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;"
                  title="Delete product"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr class="variants-row" id="variants-row-{{ product.id }}"
              data-product-name="{{ product.name|escapejs }}"
              data-base-price="{{ product.base_price }}"
              data-base-cost="{{ product.base_cost|default:0 }}"
              style="display: none;">
            <td colspan="8" style="padding: 0; background: #f8fafc;">
              <div class="variants-container" style="padding: 1rem 1rem 1rem 2.5rem;">
                <div class="variants-loading" style="text-align: center; padding: 1rem; color: #64748b;">
                  <i class="fa-solid fa-spinner fa-spin"></i> Loading variants...
                </div>
                <div class="variants-content" style="display: none;"></div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="edit_modal_title">Edit Product</h2>
        <button class="modal-close" onclick="closeEditModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="editProductForm">
          <input type="hidden" id="edit_product_id">

          <div class="form-group">
            <label for="edit_name">Product Name</label>
            <input type="text" id="edit_name" required>
          </div>

          <div class="form-group">
            <label for="edit_slug">URL Slug</label>
            <input type="text" id="edit_slug" required>
            <small style="color: #64748b; font-size: 0.8125rem; display: block; margin-top: 0.25rem;">
              Used in product URLs (e.g., /products/<strong>classic-tee</strong>)
            </small>
          </div>

          <div class="form-group">
            <label for="edit_category">Category</label>
            <select id="edit_category">
              <option value="">Uncategorized</option>
              {% for category in categories %}
              <option value="{{ category.slug }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="edit_description">Description</label>
            <textarea id="edit_description"></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="edit_base_price">Base Price ($)</label>
              <input type="number" id="edit_base_price" step="1" required>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label for="edit_base_cost">Base Cost ($)</label>
              <input type="number" id="edit_base_cost" step="1" min="0" value="0">
            </div>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="edit_featured" style="width: auto;">
              <span>Feature on homepage</span>
            </label>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="edit_available" style="width: auto;" checked>
              <span>Available for purchase</span>
            </label>
            <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; margin-left: 1.5rem;">If unchecked, product shows "Not Available" instead of Add to Cart</p>
          </div>

          <div class="form-group">
            <label>Product Images</label>
            <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Shared images used across all variants</p>
            <div id="edit_images_container" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
              <!-- Image previews will appear here -->
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <input type="file" id="edit_image_upload" accept="image/*" multiple style="display: none;" onchange="handleProductImageUpload(event)">
              <button type="button" onclick="document.getElementById('edit_image_upload').click()" class="btn btn-secondary" style="font-size: 0.8125rem; padding: 0.5rem 1rem;">
                <i class="fa-solid fa-image"></i> Upload Images
              </button>
              <button type="button" onclick="addProductImageByURL()" class="btn btn-secondary" style="font-size: 0.8125rem; padding: 0.5rem 1rem;">
                <i class="fa-solid fa-link"></i> Add URL
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Preview Body (Hidden by default) -->
      <div class="modal-body" id="preview_body" style="padding: 0; display: none; max-height: 85vh; overflow-y: auto;">
        <div style="display: grid; grid-template-columns: 45% 55%; gap: 0;">
          <!-- Left Side - Product Images -->
          <div style="background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); padding: 2rem; display: flex; flex-direction: column; gap: 0.75rem;">
            <div id="preview_main_image" style="width: 100%; aspect-ratio: 1; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);">
              <img id="preview_main_img" src="" alt="" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div style="display: flex; gap: 0.5rem;" id="preview_thumbs_container">
              <!-- Thumbnails will be populated by JavaScript -->
            </div>
          </div>

          <!-- Right Side - Product Details -->
          <div style="background: white; padding: 2rem; display: flex; flex-direction: column;">
            <!-- Category & Featured Badge -->
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span id="preview_category" style="display: inline-block; padding: 0.25rem 0.75rem; background: #f3f4f6; color: #6b7280; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Category</span>
              <span id="preview_featured_badge" style="display: none; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; border-radius: 6px; font-size: 0.7rem; font-weight: 600;">
                <i class="fa-solid fa-star"></i> Featured
              </span>
            </div>

            <!-- Product Name -->
            <h1 id="preview_name" style="font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 0.75rem; line-height: 1.2;">Product Name</h1>

            <!-- Price -->
            <div style="margin-bottom: 1rem;">
              <span style="font-size: 1.75rem; font-weight: 700; color: #111827;">$<span id="preview_price">0.00</span></span>
            </div>

            <!-- Description -->
            <div style="margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px solid #e5e7eb;">
              <p id="preview_description" style="color: #6b7280; line-height: 1.6; font-size: 0.875rem;">Product description will appear here...</p>
            </div>

            <!-- Size Selector -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Size</label>
              <div style="display: flex; gap: 0.375rem; flex-wrap: wrap;">
                <button style="padding: 0.375rem 0.875rem; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s;">XS</button>
                <button style="padding: 0.375rem 0.875rem; border: 2px solid #667eea; background: #667eea; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; color: white; cursor: pointer; transition: all 0.2s;">S</button>
                <button style="padding: 0.375rem 0.875rem; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s;">M</button>
                <button style="padding: 0.375rem 0.875rem; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s;">L</button>
                <button style="padding: 0.375rem 0.875rem; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s;">XL</button>
              </div>
            </div>

            <!-- Color Selector -->
            <div style="margin-bottom: 1.25rem;">
              <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Color</label>
              <div style="display: flex; gap: 0.5rem;">
                <button style="width: 36px; height: 36px; border: 2px solid #667eea; background: #1f2937; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></button>
                <button style="width: 36px; height: 36px; border: 2px solid #d1d5db; background: #f9fafb; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></button>
                <button style="width: 36px; height: 36px; border: 2px solid #e5e7eb; background: #3b82f6; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></button>
                <button style="width: 36px; height: 36px; border: 2px solid #e5e7eb; background: #ef4444; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></button>
              </div>
            </div>

            <!-- Quantity -->
            <div style="margin-bottom: 1.25rem;">
              <label style="display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Quantity</label>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <button style="width: 36px; height: 36px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 1.125rem; font-weight: 600; color: #374151; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚àí</button>
                <span style="font-size: 1rem; font-weight: 600; color: #111827; min-width: 24px; text-align: center;">1</span>
                <button style="width: 36px; height: 36px; border: 2px solid #e5e7eb; background: white; border-radius: 6px; font-size: 1.125rem; font-weight: 600; color: #374151; cursor: pointer; display: flex; align-items: center; justify-content: center;">+</button>
              </div>
            </div>

            <!-- Add to Cart Button -->
            <button style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-bottom: 0.75rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
              <i class="fa-solid fa-shopping-cart"></i> Add to Cart
            </button>

            <!-- Buy Now Button -->
            <button style="width: 100%; padding: 0.875rem; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-bottom: 1rem;">
              Buy Now
            </button>

            <!-- Additional Info -->
            <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #6b7280;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.375rem;">
                <i class="fa-solid fa-truck"></i> Free shipping on orders over $75
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fa-solid fa-rotate-left"></i> Store credit returns within 30 days
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer" id="edit_modal_footer">
        <button class="btn btn-secondary" id="btn_cancel" onclick="closeEditModal()">Cancel</button>
        <div style="margin-left: auto; display: flex; gap: 0.5rem;">
          <button class="btn btn-secondary" id="btn_preview" onclick="openProductPreview()">
            <i class="fa-solid fa-external-link-alt"></i>
            Preview
          </button>
          <button class="btn btn-primary" id="btn_save" onclick="saveProduct()">
            <i class="fa-solid fa-save"></i>
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Variants Modal -->
  <div class="modal-overlay" id="variantsModal">
    <div class="modal-content" style="max-width: 1400px; max-height: 95vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none;">
        <h2 id="variants_modal_title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-shapes"></i> Product Variants
        </h2>
        <button class="modal-close" onclick="closeVariantsModal()" style="color: white; background: rgba(255, 255, 255, 0.1);">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="max-height: calc(95vh - 180px); overflow-y: auto; background: #f8fafc;">
        <input type="hidden" id="variants_product_id">
        <input type="hidden" id="variants_base_price">
        <input type="hidden" id="variants_base_cost">

        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem; margin-bottom: 2rem;">
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); transition: all 0.3s;">
            <div style="color: #667eea; font-size: 2rem; margin-bottom: 0.5rem;">
              <i class="fa-solid fa-layer-group"></i>
            </div>
            <div style="color: #64748b; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem;">Total Variants</div>
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;" id="total_variants_stat">0</div>
          </div>
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); transition: all 0.3s;">
            <div style="color: #10b981; font-size: 2rem; margin-bottom: 0.5rem;">
              <i class="fa-solid fa-boxes-stacked"></i>
            </div>
            <div style="color: #64748b; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem;">Total Stock</div>
            <div style="color: #10b981; font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;" id="total_stock_stat">0</div>
          </div>
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); transition: all 0.3s;">
            <div style="color: #f59e0b; font-size: 2rem; margin-bottom: 0.5rem;">
              <i class="fa-solid fa-circle-check"></i>
            </div>
            <div style="color: #64748b; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem;">Active Variants</div>
            <div style="color: #f59e0b; font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;" id="active_variants_stat">0</div>
          </div>
          <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); transition: all 0.3s;">
            <div style="color: #ef4444; font-size: 2rem; margin-bottom: 0.5rem;">
              <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <div style="color: #64748b; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.5rem;">Low/Out Stock</div>
            <div style="color: #ef4444; font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;" id="low_stock_stat">0</div>
          </div>
        </div>

        <!-- Action Bar -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
          <input
            type="text"
            id="search_variants"
            placeholder="üîç Search variants..."
            onkeyup="filterVariants()"
            style="flex: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.875rem;"
          >
          <button onclick="openBulkVariantModal()" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 0.75rem 1.5rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); white-space: nowrap; font-weight: 600;">
            <i class="fa-solid fa-grid"></i> Bulk Add
          </button>
          <button onclick="openAddVariantForm()" class="btn btn-primary" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15); white-space: nowrap; font-weight: 600;">
            <i class="fa-solid fa-plus"></i> Add Variant
          </button>
        </div>

        <!-- Variants List -->
        <div id="variants_list">
          <!-- Variants will be loaded here -->
          <div style="text-align: center; padding: 2rem; color: #64748b;">
            <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
            <p>Loading variants...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem;">
        <button class="btn btn-secondary" onclick="closeVariantsModal()" style="padding: 0.75rem 2rem;">
          <i class="fa-solid fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Variant Modal -->
  <div class="modal-overlay" id="variantFormModal">
    <div class="modal-content" style="max-width: 800px; max-height: 95vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none;">
        <h2 id="variant_form_title" style="color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-plus-circle"></i> Add New Variant
        </h2>
        <button class="modal-close" onclick="closeVariantForm()" style="color: white; background: rgba(255, 255, 255, 0.1);">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="max-height: calc(95vh - 180px); overflow-y: auto; background: #f8fafc;">
        <input type="hidden" id="edit_variant_id">

        <!-- Core Fields -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-info-circle" style="color: #667eea; font-size: 0.875rem;"></i> Variant Details
          </h3>
          <div id="variant_attributes_container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
            <!-- Attributes will be loaded dynamically based on category -->
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
              <label for="variant_sku">SKU</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="variant_sku" placeholder="Leave blank to auto-generate" style="flex: 1;">
                <button type="button" onclick="generateVariantSKU()" class="btn btn-secondary" style="padding: 0.5rem 1rem; white-space: nowrap;">
                  <i class="fa-solid fa-wand-magic-sparkles"></i> Generate
                </button>
              </div>
            </div>
            <div class="form-group">
              <label style="color: #64748b;">Stock Quantity</label>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span id="variant_stock_display" style="font-size: 1.5rem; font-weight: 700; color: #0f172a;">0</span>
                <span style="font-size: 0.75rem; color: #94a3b8; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px;">
                  <i class="fa-solid fa-lock"></i> From shipments
                </span>
              </div>
              <input type="hidden" id="variant_stock" value="0">
            </div>
            <div class="form-group">
              <label>Price</label>
              <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; flex: 1; transition: all 0.2s;" onclick="selectPriceMode('base')" id="price_mode_base_label">
                  <input type="radio" name="price_mode" value="base" id="price_mode_base" checked style="accent-color: #667eea;">
                  <div>
                    <span style="font-weight: 600; color: #374151; font-size: 0.875rem;">Use Base Price</span>
                    <span id="base_price_display" style="display: block; font-size: 0.75rem; color: #64748b;">$0.00</span>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; flex: 1; transition: all 0.2s;" onclick="selectPriceMode('custom')" id="price_mode_custom_label">
                  <input type="radio" name="price_mode" value="custom" id="price_mode_custom" style="accent-color: #667eea;">
                  <span style="font-weight: 600; color: #374151; font-size: 0.875rem;">Custom Price</span>
                </label>
              </div>
              <div id="custom_price_input" style="display: none;">
                <input type="number" id="variant_price" step="1" min="0" placeholder="Enter custom price" style="width: 100%; padding: 0.75rem; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; font-weight: 600;">
              </div>
              <input type="hidden" id="variant_price_hidden" value="0">
            </div>
            <div class="form-group">
              <label>Cost</label>
              <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; flex: 1; transition: all 0.2s;" onclick="selectCostMode('base')" id="cost_mode_base_label">
                  <input type="radio" name="cost_mode" value="base" id="cost_mode_base" checked style="accent-color: #667eea;">
                  <div>
                    <span style="font-weight: 600; color: #374151; font-size: 0.875rem;">Use Base Cost</span>
                    <span id="base_cost_display" style="display: block; font-size: 0.75rem; color: #64748b;">$0.00</span>
                  </div>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; flex: 1; transition: all 0.2s;" onclick="selectCostMode('custom')" id="cost_mode_custom_label">
                  <input type="radio" name="cost_mode" value="custom" id="cost_mode_custom" style="accent-color: #667eea;">
                  <span style="font-weight: 600; color: #374151; font-size: 0.875rem;">Custom Cost</span>
                </label>
              </div>
              <div id="custom_cost_input" style="display: none;">
                <input type="number" id="variant_cost" step="1" min="0" placeholder="Enter custom cost" style="width: 100%; padding: 0.75rem; border: 2px solid #667eea; border-radius: 8px; font-size: 1rem; font-weight: 600;">
              </div>
              <input type="hidden" id="variant_cost_hidden" value="0">
            </div>
          </div>
        </div>

        <!-- Shared Product Images (read-only) -->
        <div id="shared_images_section" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; display: none;">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #64748b; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-image" style="color: #94a3b8; font-size: 0.875rem;"></i> Shared Product Images
          </h3>
          <p style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.75rem;">These images are used for all variants unless overridden below.</p>
          <div id="shared_images_container" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <!-- Shared images will appear here -->
          </div>
        </div>

        <!-- Variant-Specific Images -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-images" style="color: #667eea; font-size: 0.875rem;"></i> Variant-Specific Images
          </h3>
          <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.75rem;">Add images unique to this variant (optional). These will override shared images.</p>
          <div id="variant_images_container" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
            <!-- Image previews will appear here -->
          </div>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <input type="file" id="variant_image_upload" accept="image/*" multiple style="display: none;" onchange="handleVariantImageUpload(event)">
            <button type="button" onclick="document.getElementById('variant_image_upload').click()" class="btn btn-secondary">
              <i class="fa-solid fa-image"></i>
              Upload Images
            </button>
            <button type="button" onclick="addImageByURL()" class="btn btn-secondary">
              <i class="fa-solid fa-link"></i>
              Add from URL
            </button>
            <button type="button" onclick="copySharedImages()" class="btn btn-secondary" title="Copy shared product images to this variant">
              <i class="fa-solid fa-copy"></i>
              Copy from Shared
            </button>
          </div>
        </div>

        <!-- Custom Fields -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fa-solid fa-sliders" style="color: #667eea; font-size: 0.875rem;"></i> Custom Fields
            </h3>
            <button type="button" onclick="addCustomField()" class="btn btn-secondary btn-sm">
              <i class="fa-solid fa-plus"></i>
              Add Field
            </button>
          </div>
          <div id="custom_fields_container">
            <!-- Custom fields will appear here -->
            <p style="color: #64748b; font-size: 0.875rem; font-style: italic;">No custom fields added yet.</p>
          </div>
        </div>

      </div>
      <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeVariantForm()" style="padding: 0.75rem 2rem;">
          <i class="fa-solid fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" onclick="saveVariant()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 2rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
          <i class="fa-solid fa-save"></i>
          Save Variant
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Add Variants Modal -->
  <div class="modal-overlay" id="bulkVariantModal">
    <div class="modal-content" style="max-width: 700px; max-height: 95vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-bottom: none;">
        <h2 style="color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-grid"></i> Bulk Add Variants
        </h2>
        <button class="modal-close" onclick="closeBulkVariantModal()" style="color: white; background: rgba(255, 255, 255, 0.1);">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="max-height: calc(95vh - 180px); overflow-y: auto; background: #f8fafc;">
        <!-- Info Banner -->
        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #a7f3d0; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: flex-start; gap: 0.75rem;">
          <i class="fa-solid fa-lightbulb" style="color: #10b981; margin-top: 0.125rem;"></i>
          <div style="font-size: 0.875rem; color: #065f46;">
            <strong>Matrix Builder:</strong> Select multiple sizes and colors below. All combinations will be created automatically. For example, selecting 3 sizes and 2 colors will create 6 variants.
          </div>
        </div>

        <!-- Sizes Selection -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fa-solid fa-ruler" style="color: #10b981;"></i> Select Sizes
            </h3>
            <div style="display: flex; gap: 0.5rem;">
              <button type="button" onclick="selectAllSizes()" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">Select All</button>
              <button type="button" onclick="clearAllSizes()" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">Clear</button>
            </div>
          </div>
          <div id="bulk_sizes_container" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <!-- Sizes will be loaded here -->
          </div>
        </div>

        <!-- Colors Selection -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fa-solid fa-palette" style="color: #10b981;"></i> Select Colors
            </h3>
            <div style="display: flex; gap: 0.5rem;">
              <button type="button" onclick="selectAllColors()" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">Select All</button>
              <button type="button" onclick="clearAllColors()" class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">Clear</button>
            </div>
          </div>
          <div id="bulk_colors_container" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <!-- Colors will be loaded here -->
          </div>
        </div>

        <!-- Material Selection (optional) -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-layer-group" style="color: #10b981;"></i> Material (Optional)
          </h3>
          <select id="bulk_material" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem;">
            <option value="">No material</option>
            <!-- Materials will be loaded here -->
          </select>
        </div>

        <!-- Pricing & Stock -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-dollar-sign" style="color: #10b981;"></i> Pricing & Stock
          </h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Price ($) *</label>
              <input type="number" id="bulk_price" step="1" min="0" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem;">
              <div style="display: flex; gap: 0.375rem; margin-top: 0.5rem; flex-wrap: wrap;">
                <button type="button" onclick="document.getElementById('bulk_price').value='19.99'" class="price-preset-btn">$19.99</button>
                <button type="button" onclick="document.getElementById('bulk_price').value='24.99'" class="price-preset-btn">$24.99</button>
                <button type="button" onclick="document.getElementById('bulk_price').value='29.99'" class="price-preset-btn">$29.99</button>
                <button type="button" onclick="document.getElementById('bulk_price').value='34.99'" class="price-preset-btn">$34.99</button>
                <button type="button" onclick="document.getElementById('bulk_price').value='39.99'" class="price-preset-btn">$39.99</button>
                <button type="button" onclick="document.getElementById('bulk_price').value='49.99'" class="price-preset-btn">$49.99</button>
              </div>
            </div>
            <div class="form-group">
              <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #64748b; margin-bottom: 0.5rem;">Initial Stock</label>
              <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                <span style="font-size: 1.25rem; font-weight: 700; color: #0f172a;">0</span>
                <span style="font-size: 0.75rem; color: #94a3b8;"><i class="fa-solid fa-lock"></i> Add stock via shipments</span>
              </div>
              <input type="hidden" id="bulk_stock" value="0">
            </div>
          </div>
        </div>

        <!-- Preview -->
        <div style="background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-top: 1rem;">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span style="font-size: 0.875rem; color: #64748b;">
              <i class="fa-solid fa-calculator"></i> Variants to create:
            </span>
            <span id="bulk_variant_count" style="font-size: 1.25rem; font-weight: 700; color: #10b981;">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeBulkVariantModal()" style="padding: 0.75rem 2rem;">
          <i class="fa-solid fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" onclick="saveBulkVariants()" id="bulk_save_btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; padding: 0.75rem 2rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
          <i class="fa-solid fa-check"></i>
          Create Variants
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Stock Update Modal -->
  <div class="modal-overlay" id="bulkStockModal">
    <div class="modal-content" style="max-width: 500px; max-height: 95vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-bottom: none;">
        <h2 style="color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-boxes-stacked"></i> Bulk Update Stock
        </h2>
        <button class="modal-close" onclick="closeBulkStockModal()" style="color: white; background: rgba(255, 255, 255, 0.1);">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="background: #f8fafc;">
        <!-- Info Banner -->
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #fbbf24; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: flex-start; gap: 0.75rem;">
          <i class="fa-solid fa-info-circle" style="color: #d97706; margin-top: 0.125rem;"></i>
          <div style="font-size: 0.875rem; color: #92400e;">
            Update stock for all variants of this product at once. Choose to set an exact value, or add/subtract from current stock levels.
          </div>
        </div>

        <!-- Update Mode -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem;">Update Mode</h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectStockMode('set')">
              <input type="radio" name="stock_mode" value="set" checked style="width: 18px; height: 18px; accent-color: #f59e0b;">
              <div>
                <span style="font-weight: 600; color: #374151;">Set to value</span>
                <span style="display: block; font-size: 0.75rem; color: #64748b;">Set all variants to the specified stock level</span>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectStockMode('add')">
              <input type="radio" name="stock_mode" value="add" style="width: 18px; height: 18px; accent-color: #f59e0b;">
              <div>
                <span style="font-weight: 600; color: #374151;">Add to current</span>
                <span style="display: block; font-size: 0.75rem; color: #64748b;">Add the specified amount to each variant's stock</span>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectStockMode('subtract')">
              <input type="radio" name="stock_mode" value="subtract" style="width: 18px; height: 18px; accent-color: #f59e0b;">
              <div>
                <span style="font-weight: 600; color: #374151;">Subtract from current</span>
                <span style="display: block; font-size: 0.75rem; color: #64748b;">Subtract the specified amount from each variant's stock</span>
              </div>
            </label>
          </div>
        </div>

        <!-- Stock Value -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem;">
          <h3 style="font-size: 0.9375rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem;">Stock Value</h3>
          <input type="number" id="bulk_stock_value" min="0" value="0" style="width: 100%; padding: 1rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1.25rem; font-weight: 600; text-align: center;">
          <p id="stock_preview_text" style="font-size: 0.875rem; color: #64748b; margin-top: 0.75rem; text-align: center;">
            <span id="variant_count_text">All variants</span> will be set to <strong id="stock_value_preview">0</strong> units
          </p>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeBulkStockModal()" style="padding: 0.75rem 2rem;">
          <i class="fa-solid fa-times"></i> Cancel
        </button>
        <button class="btn btn-primary" onclick="saveBulkStock()" id="bulk_stock_btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 0.75rem 2rem; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
          <i class="fa-solid fa-check"></i>
          Update Stock
        </button>
      </div>
    </div>
  </div>

  <!-- Restock Modal -->
  <div class="modal-overlay" id="restockModal">
    <div class="modal-content" style="max-width: 550px; max-height: 95vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-bottom: none;">
        <h2 style="color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-truck"></i> Restock: <span id="restock_variant_sku" style="font-family: monospace;"></span>
        </h2>
        <button class="modal-close" onclick="closeRestockModal()" style="color: white; background: rgba(255, 255, 255, 0.1);">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="background: #f8fafc;">
        <!-- Current Pending Shipments -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
          <h3 style="font-size: 0.875rem; font-weight: 700; color: #64748b; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-boxes-stacked" style="color: #10b981;"></i> Current Pending Shipments
          </h3>
          <div id="restock_current_pending">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <!-- Shipment Selection -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
          <h3 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-ship" style="color: #10b981;"></i> Add to Shipment
          </h3>
          <div class="form-group" style="margin-bottom: 0.75rem;">
            <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Select Shipment</label>
            <select id="restock_shipment_select" onchange="onShipmentSelectChange()" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem; cursor: pointer;">
              <option value="">Select a shipment...</option>
              <!-- Options populated by JS -->
            </select>
          </div>

          <!-- Quick Create Shipment Form (Hidden by default) -->
          <div id="quick_shipment_form" style="display: none; margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 10px; border: 1px solid #a7f3d0;">
            <div style="font-size: 0.8125rem; font-weight: 600; color: #065f46; margin-bottom: 0.75rem;">
              <i class="fa-solid fa-plus-circle"></i> Quick Create Shipment
            </div>
            <div style="display: grid; gap: 0.75rem;">
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block;">Supplier Name *</label>
                <input type="text" id="quick_supplier" placeholder="e.g. Factory ABC" style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block;">Tracking Number (optional)</label>
                <input type="text" id="quick_tracking" placeholder="Auto-generated if empty" style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
              </div>
              <p style="font-size: 0.75rem; color: #64748b; margin: 0;">
                <i class="fa-solid fa-info-circle"></i> Expected delivery defaults to 2 weeks from today
              </p>
            </div>
          </div>
        </div>

        <!-- Quantity & Cost -->
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem;">
          <h3 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-calculator" style="color: #10b981;"></i> Quantity & Cost
          </h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block;">Quantity *</label>
              <input type="number" id="restock_quantity" min="1" placeholder="0" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; font-weight: 600; text-align: center;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; display: block;">Unit Cost ($)</label>
              <input type="number" id="restock_unit_cost" step="1" min="0" placeholder="0.00" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem; font-weight: 600; text-align: center;">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.5rem 2rem; display: flex; gap: 1rem; justify-content: space-between; align-items: center;">
        <a href="/admin/shipments/" style="font-size: 0.875rem; color: #64748b; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;" onmouseenter="this.style.color='#3b82f6'" onmouseleave="this.style.color='#64748b'">
          <i class="fa-solid fa-external-link"></i> Manage all shipments
        </a>
        <div style="display: flex; gap: 1rem;">
          <button class="btn btn-secondary" onclick="closeRestockModal()" style="padding: 0.75rem 2rem;">
            <i class="fa-solid fa-times"></i> Cancel
          </button>
          <button class="btn btn-primary" onclick="submitRestock()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; padding: 0.75rem 2rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
            <i class="fa-solid fa-check"></i>
            Add to Shipment
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Incoming Details Modal -->
  <div class="modal-overlay" id="incomingDetailsModal">
    <div class="modal-content" style="max-width: 500px; max-height: 95vh;">
      <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-bottom: none;">
        <h2 style="color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-boxes-stacked"></i> Incoming: <span id="incoming_variant_sku" style="font-family: monospace;"></span>
        </h2>
        <button class="modal-close" onclick="closeIncomingDetailsModal()" style="color: white; background: rgba(255, 255, 255, 0.1);">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <div class="modal-body" style="background: #f8fafc;">
        <!-- Summary -->
        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #93c5fd; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-truck-fast" style="color: #1d4ed8; font-size: 1.25rem;"></i>
            <span style="font-weight: 600; color: #1e40af;">Total Incoming</span>
          </div>
          <span id="incoming_total_count" style="font-size: 1.5rem; font-weight: 800; color: #1d4ed8;">0</span>
        </div>

        <!-- Shipment List -->
        <div id="incoming_details_list">
          <!-- Will be populated by JS -->
        </div>
      </div>
      <div class="modal-footer" style="background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 1.25rem 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeIncomingDetailsModal()" style="padding: 0.75rem 2rem;">
          <i class="fa-solid fa-times"></i> Close
        </button>
        <a href="/admin/shipments/" class="btn btn-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border: none; padding: 0.75rem 2rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); text-decoration: none;">
          <i class="fa-solid fa-external-link"></i>
          View All Shipments
        </a>
      </div>
    </div>
  </div>

  <script>
    // Product Preview Functions - v3.0 - BUTTON TOGGLE FIX
    console.log('Script loaded - v3.0');

    function getCookie(name) {
      // First try to get from cookie
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }

      // If not found in cookie and we're looking for csrftoken, try meta tag
      if (!cookieValue && name === 'csrftoken') {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
          cookieValue = metaTag.getAttribute('content');
        }
      }

      return cookieValue;
    }

    function applySort(sortValue) {
      const url = new URL(window.location.href);
      url.searchParams.set('sort', sortValue);
      window.location.href = url.toString();
    }

    function deleteProduct(productId, productName) {
      if (!confirm(`Are you sure you want to delete "${productName}"?\n\nThis will also delete all variants and cannot be undone.`)) {
        return;
      }

      const csrftoken = getCookie('csrftoken');
      const formData = new FormData();
      formData.append('action', 'delete_product');
      formData.append('product_id', productId);
      formData.append('csrfmiddlewaretoken', csrftoken);

      fetch(window.location.pathname, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Remove the row from the table
          const row = document.querySelector(`tr:has(button[onclick*="deleteProduct(${productId},"])`);
          if (row) {
            row.style.transition = 'opacity 0.3s';
            row.style.opacity = '0';
            setTimeout(() => row.remove(), 300);
          }
          showToast(data.message || 'Product deleted successfully');
        } else {
          showToast(data.error || 'Failed to delete product', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    function showToast(message, type = 'success') {
      // Check if toast exists, create if not
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = 'position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 2000; transform: translateY(100px); opacity: 0; transition: all 0.3s;';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.background = type === 'error' ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      toast.style.color = 'white';
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(100px)';
        toast.style.opacity = '0';
      }, 3000);
    }

    function toggleActive(element) {
      const productId = element.dataset.productId;
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'toggle_active',
          'product_id': productId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        }
      });
    }

    // Track loaded variants to avoid re-fetching
    const loadedVariants = {};

    function toggleProductExpand(row, event) {
      const productId = row.dataset.productId;
      const variantsRow = document.getElementById('variants-row-' + productId);
      const expandIcon = row.querySelector('.expand-icon');
      const isExpanded = variantsRow.style.display !== 'none';

      if (isExpanded) {
        // Collapse
        variantsRow.style.display = 'none';
        expandIcon.style.transform = 'rotate(0deg)';
        row.style.background = '';
      } else {
        // Expand
        variantsRow.style.display = 'table-row';
        expandIcon.style.transform = 'rotate(90deg)';
        row.style.background = '#f8fafc';

        // Load variants if not already loaded
        if (!loadedVariants[productId]) {
          loadVariantsForProduct(productId);
        }
      }
    }

    function loadVariantsForProduct(productId) {
      const variantsRow = document.getElementById('variants-row-' + productId);
      const loadingDiv = variantsRow.querySelector('.variants-loading');
      const contentDiv = variantsRow.querySelector('.variants-content');
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_variants',
          'product_id': productId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          loadedVariants[productId] = data.variants;
          renderInlineVariants(productId, data.variants, contentDiv);
          loadingDiv.style.display = 'none';
          contentDiv.style.display = 'block';
        } else {
          loadingDiv.innerHTML = '<span style="color: #dc2626;">Failed to load variants</span>';
        }
      })
      .catch(error => {
        loadingDiv.innerHTML = '<span style="color: #dc2626;">Error loading variants</span>';
      });
    }

    function renderInlineVariants(productId, variants, container) {
      if (variants.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 1rem; color: #64748b;">
            <i class="fa-solid fa-box-open" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <p>No variants yet</p>
          </div>
        `;
        return;
      }

      let html = `
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
          <thead>
            <tr style="background: #e2e8f0;">
              <th style="padding: 0.5rem 0.75rem; text-align: left; font-weight: 600; color: #475569;">SKU</th>
              <th style="padding: 0.5rem 0.75rem; text-align: left; font-weight: 600; color: #475569;">Size</th>
              <th style="padding: 0.5rem 0.75rem; text-align: left; font-weight: 600; color: #475569;">Color</th>
              <th style="padding: 0.5rem 0.75rem; text-align: center; font-weight: 600; color: #475569;">Stock</th>
              <th style="padding: 0.5rem 0.75rem; text-align: center; font-weight: 600; color: #475569;">Incoming</th>
              <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: #475569;">Price</th>
              <th style="padding: 0.5rem 0.75rem; text-align: right; font-weight: 600; color: #475569;">Cost</th>
              <th style="padding: 0.5rem 0.75rem; text-align: center; font-weight: 600; color: #475569;">Status</th>
            </tr>
          </thead>
          <tbody>
      `;

      variants.forEach((v, index) => {
        const rowBg = index % 2 === 0 ? 'white' : '#f8fafc';
        const stockColor = v.stock_quantity === 0 ? '#dc2626' : (v.stock_quantity < 10 ? '#f59e0b' : '#10b981');
        const statusBadge = v.is_active
          ? '<span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>'
          : '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Inactive</span>';

        html += `
          <tr style="background: ${rowBg}; border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.8125rem; color: #64748b;">${v.sku || '-'}</td>
            <td style="padding: 0.5rem 0.75rem;">${v.size || '-'}</td>
            <td style="padding: 0.5rem 0.75rem;">${v.color || '-'}</td>
            <td style="padding: 0.5rem 0.75rem; text-align: center;">
              <span style="color: ${stockColor}; font-weight: 600;">${v.stock_quantity}</span>
            </td>
            <td style="padding: 0.5rem 0.75rem; text-align: center;">
              ${v.pending_total > 0 ? `<span style="background: #dbeafe; color: #1d4ed8; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">+${v.pending_total}</span>` : '<span style="color: #94a3b8;">-</span>'}
            </td>
            <td style="padding: 0.5rem 0.75rem; text-align: right;">
              <span style="font-weight: 600;">$${parseFloat(v.price).toFixed(2)}</span>
              ${v.has_custom_price ? '<span style="font-size: 0.625rem; background: #f5f3ff; color: #667eea; padding: 0.125rem 0.25rem; border-radius: 3px; margin-left: 0.25rem;">CUSTOM</span>' : ''}
            </td>
            <td style="padding: 0.5rem 0.75rem; text-align: right;">
              <span style="color: #64748b;">$${parseFloat(v.cost || 0).toFixed(2)}</span>
              ${v.has_custom_cost ? '<span style="font-size: 0.625rem; background: #fef3c7; color: #92400e; padding: 0.125rem 0.25rem; border-radius: 3px; margin-left: 0.25rem;">CUSTOM</span>' : ''}
            </td>
            <td style="padding: 0.5rem 0.75rem; text-align: center;">${statusBadge}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      html += `
        <div style="display: flex; justify-content: flex-end; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0;">
          <button onclick="openVariantsModalById(${productId})" class="btn btn-secondary btn-sm" style="font-size: 0.8125rem;">
            <i class="fa-solid fa-shapes"></i> Manage Variants
          </button>
        </div>
      `;
      container.innerHTML = html;
    }

    function openVariantsModalById(productId) {
      // Find the variants row which has the data attributes
      const variantsRow = document.getElementById('variants-row-' + productId);
      if (!variantsRow) return;

      const productName = variantsRow.dataset.productName;
      const basePrice = variantsRow.dataset.basePrice;
      const baseCost = variantsRow.dataset.baseCost;

      openVariantsModal(productId, productName, basePrice, baseCost, []);
    }

    function updatePrice(input) {
      const productId = input.dataset.productId;
      const newPrice = input.value;
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'update_price',
          'product_id': productId,
          'price': newPrice
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          input.style.borderColor = '#10b981';
          setTimeout(() => {
            input.style.borderColor = '#e2e8f0';
          }, 1000);
        }
      });
    }

    let productImages = [];

    function openEditModal(id, name, slug, category, description, price, cost, featured, available, images) {
      document.getElementById('edit_product_id').value = id;
      document.getElementById('edit_name').value = name;
      document.getElementById('edit_slug').value = slug;
      document.getElementById('edit_category').value = category;
      document.getElementById('edit_description').value = description;
      document.getElementById('edit_base_price').value = price;
      document.getElementById('edit_base_cost').value = cost || 0;
      document.getElementById('edit_featured').checked = featured;
      document.getElementById('edit_available').checked = available !== false;

      // Load product images (passed directly as array)
      productImages = Array.isArray(images) ? [...images] : [];
      displayProductImages();

      document.getElementById('editModal').classList.add('active');
    }

    function handleProductImageUpload(event) {
      const files = event.target.files;
      for (let file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
          productImages.push(e.target.result);
          displayProductImages();
        };
        reader.readAsDataURL(file);
      }
      event.target.value = '';
    }

    function addProductImageByURL() {
      const url = prompt('Enter image URL:');
      if (url) {
        productImages.push(url);
        displayProductImages();
      }
    }

    let draggedImageIndex = null;

    function displayProductImages() {
      const container = document.getElementById('edit_images_container');
      container.innerHTML = '';

      if (productImages.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; font-size: 0.8125rem; font-style: italic;">No images added yet.</p>';
        return;
      }

      productImages.forEach((img, index) => {
        const imgSrc = img.startsWith('/') || img.startsWith('http') || img.startsWith('data:') ? img : `/static/${img}`;
        const imgDiv = document.createElement('div');
        imgDiv.draggable = true;
        imgDiv.dataset.index = index;
        imgDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; cursor: grab; transition: transform 0.15s, border-color 0.15s;';

        // Drag events
        imgDiv.ondragstart = (e) => {
          draggedImageIndex = index;
          imgDiv.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        };
        imgDiv.ondragend = () => {
          imgDiv.style.opacity = '1';
          draggedImageIndex = null;
          // Remove all drag-over styles
          container.querySelectorAll('[data-index]').forEach(el => {
            el.style.borderColor = '#e2e8f0';
            el.style.transform = 'none';
          });
        };
        imgDiv.ondragover = (e) => {
          e.preventDefault();
          if (draggedImageIndex !== null && draggedImageIndex !== index) {
            imgDiv.style.borderColor = '#667eea';
            imgDiv.style.transform = 'scale(1.05)';
          }
        };
        imgDiv.ondragleave = () => {
          imgDiv.style.borderColor = '#e2e8f0';
          imgDiv.style.transform = 'none';
        };
        imgDiv.ondrop = (e) => {
          e.preventDefault();
          if (draggedImageIndex !== null && draggedImageIndex !== index) {
            // Reorder images
            const draggedImg = productImages[draggedImageIndex];
            productImages.splice(draggedImageIndex, 1);
            productImages.splice(index, 0, draggedImg);
            displayProductImages();
          }
        };

        imgDiv.innerHTML = `
          <img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="this.src='/static/images/white_bg_top.webp'">
          <div style="position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 4px; width: 20px; height: 20px; font-size: 0.6875rem; display: flex; align-items: center; justify-content: center; font-weight: 600;">${index + 1}</div>
          <button type="button" onclick="event.stopPropagation(); removeProductImage(${index})" style="position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
            <i class="fa-solid fa-times"></i>
          </button>
        `;
        container.appendChild(imgDiv);
      });

      // Add helper text if multiple images
      if (productImages.length > 1) {
        const helpText = document.createElement('p');
        helpText.style.cssText = 'width: 100%; font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem;';
        helpText.innerHTML = '<i class="fa-solid fa-arrows-up-down-left-right"></i> Drag to reorder. First image is the main product image.';
        container.appendChild(helpText);
      }
    }

    function removeProductImage(index) {
      productImages.splice(index, 1);
      displayProductImages();
    }

    function closeEditModal() {
      // Reset to edit view if in preview mode
      if (document.getElementById('preview_body').style.display === 'block') {
        closePreview();
      }
      document.getElementById('editModal').classList.remove('active');
    }

    function saveProduct() {
      const productId = document.getElementById('edit_product_id').value;
      const csrftoken = document.querySelector('meta[name="csrf-token"]').content;

      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', csrftoken);
      formData.append('action', 'update_product');
      formData.append('product_id', productId);
      formData.append('name', document.getElementById('edit_name').value);
      formData.append('slug', document.getElementById('edit_slug').value);
      formData.append('category', document.getElementById('edit_category').value);
      formData.append('description', document.getElementById('edit_description').value);
      formData.append('base_price', document.getElementById('edit_base_price').value);
      formData.append('base_cost', document.getElementById('edit_base_cost').value || '0');
      formData.append('featured', document.getElementById('edit_featured').checked ? 'true' : 'false');
      formData.append('available_for_purchase', document.getElementById('edit_available').checked ? 'true' : 'false');
      formData.append('images', JSON.stringify(productImages));

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          closeEditModal();
          location.reload();
        } else {
          showToast('Error: ' + (data.error || 'Failed to save product'), 'error');
        }
      })
      .catch(error => {
        console.error('Save error:', error);
        showToast('Error saving product: ' + error.message, 'error');
      });
    }

    // Close modal on overlay click
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeEditModal();
      }
    });

    function openProductPreview() {
      // Get product slug from the edit form
      const slug = document.getElementById('edit_slug').value;
      if (slug) {
        // Open actual product page in new tab
        window.open(`/shop/product/${slug}/`, '_blank');
      } else {
        showToast('Please save the product first to preview it.', 'error');
      }
    }

    function changePreviewImage(thumbElement) {
      // Remove active border from all thumbnails
      document.querySelectorAll('.preview_thumb').forEach(t => {
        t.style.border = '2px solid transparent';
      });

      // Add active border to clicked thumbnail
      thumbElement.style.border = '2px solid #667eea';

      // Change main image
      const thumbImg = thumbElement.querySelector('img');
      const mainImg = document.getElementById('preview_main_img');
      mainImg.src = thumbImg.src.replace('w=150&h=150', 'w=600&h=600');
    }

    function closePreview() {
      // Hide preview body
      document.getElementById('preview_body').style.display = 'none';

      // Show edit form body
      const editBody = document.querySelector('#editModal .modal-body:not(#preview_body)');
      if (editBody) {
        editBody.style.display = 'block';
      }

      // Restore modal title
      document.querySelector('#edit_modal_title').textContent = 'Edit Product';

      // Restore modal width
      document.querySelector('#editModal .modal-content').style.maxWidth = '600px';

      // Show Preview button, hide Back to Edit button
      document.getElementById('btn_cancel').style.display = 'inline-flex';
      document.getElementById('btn_preview').style.display = 'inline-flex';
      document.getElementById('btn_back_to_edit').style.display = 'none';
      document.getElementById('btn_save').style.display = 'inline-flex';
    }

    // Global variants data
    let allVariants = [];
    let variantImages = [];
    let customFieldsData = {};
    let sharedProductImages = [];

    // Variants Modal Functions
    function openVariantsModal(productId, productName, basePrice, baseCost, productImages) {
      document.getElementById('variants_product_id').value = productId;
      document.getElementById('variants_base_price').value = basePrice || '';
      document.getElementById('variants_base_cost').value = baseCost || '0';
      document.getElementById('variants_modal_title').innerHTML = `<i class="fa-solid fa-shapes"></i> Variants: ${productName}`;
      document.getElementById('variantsModal').classList.add('active');

      // Store shared product images for display in variant form
      sharedProductImages = Array.isArray(productImages) ? productImages : [];

      // Load sizes, colors, and materials
      loadSizesColorsMaterials();

      // Load existing variants
      loadVariants(productId);
    }

    function closeVariantsModal() {
      document.getElementById('variantsModal').classList.remove('active');
      // Reload page to refresh counts
      location.reload();
    }

    function openAddVariantForm() {
      console.log('Opening add variant form');
      document.getElementById('edit_variant_id').value = '';
      document.getElementById('variant_form_title').innerHTML = '<i class="fa-solid fa-plus-circle"></i> Add New Variant';

      // Reset form fields
      document.getElementById('variant_sku').value = '';
      document.getElementById('variant_stock').value = '0';
      document.getElementById('variant_stock_display').textContent = '0';

      // Set price to base price mode
      const basePrice = document.getElementById('variants_base_price').value || '0';
      document.getElementById('base_price_display').textContent = '$' + parseFloat(basePrice).toFixed(2);
      selectPriceMode('base');
      document.getElementById('variant_price').value = basePrice;

      // Set cost to base cost mode
      const baseCost = document.getElementById('variants_base_cost').value || '0';
      document.getElementById('base_cost_display').textContent = '$' + parseFloat(baseCost).toFixed(2);
      selectCostMode('base');
      document.getElementById('variant_cost').value = baseCost;

      // Clear images and custom fields
      variantImages = [];
      customFieldsData = {};
      displayVariantImages();
      displaySharedImages();
      document.getElementById('custom_fields_container').innerHTML = '<p style="color: #64748b; font-size: 0.875rem; font-style: italic;">No custom fields added yet.</p>';

      // Load dynamic attributes based on category
      loadVariantAttributes();

      document.getElementById('variantFormModal').classList.add('active');
    }

    function loadVariantAttributes() {
      // Get product ID from the variants modal
      const productId = document.getElementById('variants_product_id').value;
      const csrftoken = getCookie('csrftoken');

      console.log('Loading variant attributes for product:', productId);
      console.log('CSRF token:', csrftoken);
      console.log('CSRF token length:', csrftoken ? csrftoken.length : 'null');

      // Fetch category attributes from backend
      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_product_category_attributes',
          'product_id': productId
        })
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Category attributes response:', data);

        if (!data.success) {
          console.error('Failed to load category attributes:', data.error);
          showToast('Error: ' + data.error, 'error');
          return;
        }

        // Build form fields dynamically based on category
        const container = document.getElementById('variant_attributes_container');
        let fieldsHTML = '';

        // Add Size field if category uses it
        if (data.uses_size) {
          fieldsHTML += `
            <div class="form-group">
              <label for="variant_size">Size *</label>
              <select id="variant_size" required>
                <option value="">Select size...</option>
              </select>
            </div>
          `;
        }

        // Add Color field if category uses it
        if (data.uses_color) {
          fieldsHTML += `
            <div class="form-group">
              <label for="variant_color">Color *</label>
              <select id="variant_color" required>
                <option value="">Select color...</option>
              </select>
            </div>
          `;
        }

        // Add Material field if category uses it
        if (data.uses_material) {
          fieldsHTML += `
            <div class="form-group">
              <label for="variant_material">Material</label>
              <select id="variant_material">
                <option value="">Select material...</option>
              </select>
            </div>
          `;
        }

        // Add custom attributes
        if (data.custom_attributes && data.custom_attributes.length > 0) {
          data.custom_attributes.forEach((attr, index) => {
            fieldsHTML += `
              <div class="form-group">
                <label for="variant_custom_${index}">${attr.name}${attr.required ? ' *' : ''}</label>
                ${attr.type === 'select' && attr.options ? `
                  <select id="variant_custom_${index}" ${attr.required ? 'required' : ''}>
                    <option value="">Select ${attr.name.toLowerCase()}...</option>
                    ${attr.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                  </select>
                ` : `
                  <input type="text" id="variant_custom_${index}" ${attr.required ? 'required' : ''} placeholder="Enter ${attr.name.toLowerCase()}">
                `}
              </div>
            `;
          });
        }

        container.innerHTML = fieldsHTML;

        // Show common fields as quick-add buttons
        if (data.common_fields && data.common_fields.length > 0) {
          const customFieldsSection = document.querySelector('#custom_fields_container').parentElement;

          // Remove any existing quick-add section
          const existingQuickAdd = customFieldsSection.querySelector('.quick-add-fields');
          if (existingQuickAdd) {
            existingQuickAdd.remove();
          }

          // Add quick-add buttons section
          let quickAddHTML = `
            <div class="quick-add-fields" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
              <div style="font-size: 0.8125rem; font-weight: 600; color: #64748b; margin-bottom: 0.75rem;">
                <i class="fa-solid fa-lightbulb" style="color: #f59e0b;"></i> Common fields for ${data.category_name}:
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          `;

          data.common_fields.forEach((field, index) => {
            quickAddHTML += `
              <button type="button" onclick="addSavedField('${field.name.toLowerCase().replace(/\s+/g, '_')}', '${field.name}')"
                      class="btn btn-secondary btn-sm"
                      style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0;">
                <i class="fa-solid fa-plus"></i> ${field.name}
              </button>
            `;
          });

          quickAddHTML += `
              </div>
            </div>
          `;

          customFieldsSection.insertAdjacentHTML('beforeend', quickAddHTML);
        }

        // Load the options for standard attributes
        loadFormDropdowns();
      })
      .catch(error => {
        console.error('Error loading variant attributes:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack
        });
        showToast('Error loading variant attributes', 'error');
      });
    }

    function closeVariantForm() {
      document.getElementById('variantFormModal').classList.remove('active');
    }

    function selectPriceMode(mode) {
      const baseLabel = document.getElementById('price_mode_base_label');
      const customLabel = document.getElementById('price_mode_custom_label');
      const customInput = document.getElementById('custom_price_input');
      const basePriceRadio = document.getElementById('price_mode_base');
      const customPriceRadio = document.getElementById('price_mode_custom');
      const priceInput = document.getElementById('variant_price');
      const basePrice = document.getElementById('variants_base_price').value || '0';

      if (mode === 'base') {
        basePriceRadio.checked = true;
        baseLabel.style.borderColor = '#667eea';
        baseLabel.style.background = '#f5f3ff';
        customLabel.style.borderColor = '#e2e8f0';
        customLabel.style.background = '#f8fafc';
        customInput.style.display = 'none';
        priceInput.value = basePrice;
      } else {
        customPriceRadio.checked = true;
        customLabel.style.borderColor = '#667eea';
        customLabel.style.background = '#f5f3ff';
        baseLabel.style.borderColor = '#e2e8f0';
        baseLabel.style.background = '#f8fafc';
        customInput.style.display = 'block';
        priceInput.focus();
      }
    }

    function selectCostMode(mode) {
      const baseLabel = document.getElementById('cost_mode_base_label');
      const customLabel = document.getElementById('cost_mode_custom_label');
      const customInput = document.getElementById('custom_cost_input');
      const baseCostRadio = document.getElementById('cost_mode_base');
      const customCostRadio = document.getElementById('cost_mode_custom');
      const costInput = document.getElementById('variant_cost');
      const baseCost = document.getElementById('variants_base_cost').value || '0';

      if (mode === 'base') {
        baseCostRadio.checked = true;
        baseLabel.style.borderColor = '#667eea';
        baseLabel.style.background = '#f5f3ff';
        customLabel.style.borderColor = '#e2e8f0';
        customLabel.style.background = '#f8fafc';
        customInput.style.display = 'none';
        costInput.value = baseCost;
      } else {
        customCostRadio.checked = true;
        customLabel.style.borderColor = '#667eea';
        customLabel.style.background = '#f5f3ff';
        baseLabel.style.borderColor = '#e2e8f0';
        baseLabel.style.background = '#f8fafc';
        customInput.style.display = 'block';
        costInput.focus();
      }
    }

    function generateVariantSKU() {
      // Get the selected attribute values
      const sizeSelect = document.getElementById('variant_size');
      const colorSelect = document.getElementById('variant_color');
      const materialSelect = document.getElementById('variant_material');

      // Get product name from the modal title
      const titleText = document.getElementById('variants_modal_title').textContent;
      const productName = titleText.replace('Variants:', '').trim();

      // Build SKU parts
      let skuParts = [];

      // Add product name part (first word or abbreviation)
      if (productName) {
        const productPart = productName.split(' ').slice(0, 2).join('').toUpperCase();
        skuParts.push(productPart);
      }

      // Add size if selected
      if (sizeSelect && sizeSelect.value) {
        const sizeText = sizeSelect.options[sizeSelect.selectedIndex].text;
        skuParts.push(sizeText.toUpperCase().replace(/\s+/g, ''));
      }

      // Add color if selected
      if (colorSelect && colorSelect.value) {
        const colorText = colorSelect.options[colorSelect.selectedIndex].text;
        skuParts.push(colorText.toUpperCase().replace(/\s+/g, ''));
      }

      // Add material if selected
      if (materialSelect && materialSelect.value) {
        const materialText = materialSelect.options[materialSelect.selectedIndex].text;
        skuParts.push(materialText.toUpperCase().replace(/\s+/g, ''));
      }

      // Join with hyphens
      const sku = skuParts.join('-');

      // Set the SKU field
      document.getElementById('variant_sku').value = sku;
    }

    function loadSizesColorsMaterials() {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_sizes_colors_materials'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Populate filter dropdowns
          const filterSize = document.getElementById('filter_size');
          filterSize.innerHTML = '<option value="">All Sizes</option>';
          data.sizes.forEach(size => {
            const option = document.createElement('option');
            option.value = size.label;
            option.textContent = size.label;
            filterSize.appendChild(option);
          });

          const filterColor = document.getElementById('filter_color');
          filterColor.innerHTML = '<option value="">All Colors</option>';
          data.colors.forEach(color => {
            const option = document.createElement('option');
            option.value = color.name;
            option.textContent = color.name;
            filterColor.appendChild(option);
          });

          const filterMaterial = document.getElementById('filter_material');
          filterMaterial.innerHTML = '<option value="">All Materials</option>';
          if (data.materials) {
            data.materials.forEach(material => {
              const option = document.createElement('option');
              option.value = material.name;
              option.textContent = material.name;
              filterMaterial.appendChild(option);
            });
          }
        }
      });
    }

    function loadFormDropdowns() {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_sizes_colors_materials'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Populate Size dropdown if it exists
          const sizeSelect = document.getElementById('variant_size');
          if (sizeSelect) {
            sizeSelect.innerHTML = '<option value="">Select size...</option>';
            data.sizes.forEach(size => {
              const option = document.createElement('option');
              option.value = size.id;
              option.textContent = size.label;
              sizeSelect.appendChild(option);
            });
          }

          // Populate Color dropdown if it exists
          const colorSelect = document.getElementById('variant_color');
          if (colorSelect) {
            colorSelect.innerHTML = '<option value="">Select color...</option>';
            data.colors.forEach(color => {
              const option = document.createElement('option');
              option.value = color.id;
              option.textContent = color.name;
              colorSelect.appendChild(option);
            });
          }

          // Populate Material dropdown if it exists
          const materialSelect = document.getElementById('variant_material');
          if (materialSelect && data.materials) {
            materialSelect.innerHTML = '<option value="">Select material...</option>';
            data.materials.forEach(material => {
              const option = document.createElement('option');
              option.value = material.id;
              option.textContent = material.name;
              materialSelect.appendChild(option);
            });
          }
        }
      });
    }

    // ============================================
    // BULK VARIANT FUNCTIONS
    // ============================================
    let bulkSizesData = [];
    let bulkColorsData = [];
    let selectedSizes = [];
    let selectedColors = [];

    function openBulkVariantModal() {
      // Reset selections
      selectedSizes = [];
      selectedColors = [];

      // Set default price from product's base price
      document.getElementById('bulk_price').value = document.getElementById('variants_base_price').value || '';
      document.getElementById('bulk_stock').value = '0';
      document.getElementById('bulk_material').value = '';

      // Load sizes and colors
      loadBulkFormData();

      document.getElementById('bulkVariantModal').classList.add('active');
      updateBulkVariantCount();
    }

    function closeBulkVariantModal() {
      document.getElementById('bulkVariantModal').classList.remove('active');
    }

    function loadBulkFormData() {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_sizes_colors_materials'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bulkSizesData = data.sizes;
          bulkColorsData = data.colors;

          // Render size checkboxes
          const sizesContainer = document.getElementById('bulk_sizes_container');
          sizesContainer.innerHTML = data.sizes.map(size => `
            <label class="bulk-checkbox" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none;">
              <input type="checkbox" value="${size.id}" onchange="toggleSize(${size.id})" style="width: 16px; height: 16px; accent-color: #10b981;">
              <span style="font-weight: 600; color: #374151;">${size.label}</span>
            </label>
          `).join('');

          // Render color checkboxes
          const colorsContainer = document.getElementById('bulk_colors_container');
          colorsContainer.innerHTML = data.colors.map(color => `
            <label class="bulk-checkbox" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none;">
              <input type="checkbox" value="${color.id}" onchange="toggleColor(${color.id})" style="width: 16px; height: 16px; accent-color: #10b981;">
              <span style="font-weight: 600; color: #374151;">${color.name}</span>
            </label>
          `).join('');

          // Render material dropdown
          const materialSelect = document.getElementById('bulk_material');
          materialSelect.innerHTML = '<option value="">No material</option>';
          if (data.materials) {
            data.materials.forEach(material => {
              const option = document.createElement('option');
              option.value = material.id;
              option.textContent = material.name;
              materialSelect.appendChild(option);
            });
          }
        }
      });
    }

    function toggleSize(sizeId) {
      const index = selectedSizes.indexOf(sizeId);
      if (index > -1) {
        selectedSizes.splice(index, 1);
      } else {
        selectedSizes.push(sizeId);
      }
      updateBulkVariantCount();
      updateCheckboxStyles();
    }

    function toggleColor(colorId) {
      const index = selectedColors.indexOf(colorId);
      if (index > -1) {
        selectedColors.splice(index, 1);
      } else {
        selectedColors.push(colorId);
      }
      updateBulkVariantCount();
      updateCheckboxStyles();
    }

    function selectAllSizes() {
      selectedSizes = bulkSizesData.map(s => s.id);
      document.querySelectorAll('#bulk_sizes_container input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateBulkVariantCount();
      updateCheckboxStyles();
    }

    function clearAllSizes() {
      selectedSizes = [];
      document.querySelectorAll('#bulk_sizes_container input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateBulkVariantCount();
      updateCheckboxStyles();
    }

    function selectAllColors() {
      selectedColors = bulkColorsData.map(c => c.id);
      document.querySelectorAll('#bulk_colors_container input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateBulkVariantCount();
      updateCheckboxStyles();
    }

    function clearAllColors() {
      selectedColors = [];
      document.querySelectorAll('#bulk_colors_container input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateBulkVariantCount();
      updateCheckboxStyles();
    }

    function updateCheckboxStyles() {
      // Update size checkbox styles
      document.querySelectorAll('#bulk_sizes_container .bulk-checkbox').forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          label.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
          label.style.borderColor = '#10b981';
        } else {
          label.style.background = '#f1f5f9';
          label.style.borderColor = '#e2e8f0';
        }
      });

      // Update color checkbox styles
      document.querySelectorAll('#bulk_colors_container .bulk-checkbox').forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          label.style.background = 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)';
          label.style.borderColor = '#10b981';
        } else {
          label.style.background = '#f1f5f9';
          label.style.borderColor = '#e2e8f0';
        }
      });
    }

    function updateBulkVariantCount() {
      const count = selectedSizes.length * selectedColors.length;
      document.getElementById('bulk_variant_count').textContent = count;

      // Update button state
      const btn = document.getElementById('bulk_save_btn');
      if (count > 0) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.innerHTML = `<i class="fa-solid fa-check"></i> Create ${count} Variant${count > 1 ? 's' : ''}`;
      } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Create Variants';
      }
    }

    function saveBulkVariants() {
      const productId = document.getElementById('variants_product_id').value;
      const price = document.getElementById('bulk_price').value;
      const stock = document.getElementById('bulk_stock').value || 0;
      const materialId = document.getElementById('bulk_material').value;

      if (selectedSizes.length === 0 || selectedColors.length === 0) {
        showToast('Please select at least one size and one color', 'error');
        return;
      }

      if (!price) {
        showToast('Please enter a price', 'error');
        return;
      }

      const csrftoken = getCookie('csrftoken');
      const btn = document.getElementById('bulk_save_btn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';
      btn.disabled = true;

      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', csrftoken);
      formData.append('action', 'bulk_create_variants');
      formData.append('product_id', productId);
      formData.append('size_ids', JSON.stringify(selectedSizes));
      formData.append('color_ids', JSON.stringify(selectedColors));
      formData.append('material_id', materialId);
      formData.append('price', price);
      formData.append('stock_quantity', stock);

      fetch(window.location.pathname, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(data.message, 'success');
          closeBulkVariantModal();
          // Reload variants list
          loadVariants(productId);
        } else {
          showToast('Error: ' + (data.error || 'Failed to create variants'), 'error');
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      })
      .catch(error => {
        showToast('Error creating variants', 'error');
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      });
    }

    // ============================================
    // BULK STOCK UPDATE FUNCTIONS
    // ============================================
    let currentStockMode = 'set';

    function openBulkStockModal() {
      // Reset form
      currentStockMode = 'set';
      document.querySelector('input[name="stock_mode"][value="set"]').checked = true;
      document.getElementById('bulk_stock_value').value = '0';

      // Update preview text
      updateStockPreviewText();

      // Show variant count
      document.getElementById('variant_count_text').textContent = `${allVariants.length} variant${allVariants.length !== 1 ? 's' : ''}`;

      document.getElementById('bulkStockModal').classList.add('active');

      // Add input listener
      document.getElementById('bulk_stock_value').addEventListener('input', updateStockPreviewText);
    }

    function closeBulkStockModal() {
      document.getElementById('bulkStockModal').classList.remove('active');
    }

    function selectStockMode(mode) {
      currentStockMode = mode;

      // Update radio button styles
      document.querySelectorAll('#bulkStockModal label').forEach(label => {
        const radio = label.querySelector('input[type="radio"]');
        if (radio && radio.checked) {
          label.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
          label.style.borderColor = '#f59e0b';
        } else if (radio) {
          label.style.background = '#f1f5f9';
          label.style.borderColor = '#e2e8f0';
        }
      });

      updateStockPreviewText();
    }

    function updateStockPreviewText() {
      const value = document.getElementById('bulk_stock_value').value || 0;
      const previewEl = document.getElementById('stock_value_preview');
      const textEl = document.getElementById('stock_preview_text');

      previewEl.textContent = value;

      const variantCount = allVariants.length;
      const modeDescriptions = {
        'set': `${variantCount} variant${variantCount !== 1 ? 's' : ''} will be set to <strong>${value}</strong> units`,
        'add': `<strong>${value}</strong> units will be added to each of ${variantCount} variant${variantCount !== 1 ? 's' : ''}`,
        'subtract': `<strong>${value}</strong> units will be subtracted from each of ${variantCount} variant${variantCount !== 1 ? 's' : ''}`
      };

      textEl.innerHTML = modeDescriptions[currentStockMode] || modeDescriptions['set'];
    }

    function saveBulkStock() {
      const productId = document.getElementById('variants_product_id').value;
      const stockValue = document.getElementById('bulk_stock_value').value || 0;

      const csrftoken = getCookie('csrftoken');
      const btn = document.getElementById('bulk_stock_btn');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';
      btn.disabled = true;

      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', csrftoken);
      formData.append('action', 'bulk_update_stock');
      formData.append('product_id', productId);
      formData.append('update_mode', currentStockMode);
      formData.append('stock_value', stockValue);
      // Not passing variant_ids means update all variants

      fetch(window.location.pathname, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(data.message, 'success');
          closeBulkStockModal();
          // Reload variants list
          loadVariants(productId);
        } else {
          showToast('Error: ' + (data.error || 'Failed to update stock'), 'error');
          btn.innerHTML = originalHTML;
          btn.disabled = false;
        }
      })
      .catch(error => {
        showToast('Error updating stock', 'error');
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      });
    }

    function loadVariants(productId) {
      const csrftoken = getCookie('csrftoken');
      console.log('Loading variants for product:', productId);

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_variants',
          'product_id': productId
        })
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Variants data:', data);
        if (data.success) {
          allVariants = data.variants;
          displayVariants(allVariants);
        } else {
          console.error('Failed to load variants:', data.error);
          document.getElementById('variants_list').innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #ef4444;">
              <i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
              <p>Error loading variants: ${data.error || 'Unknown error'}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error loading variants:', error);
        document.getElementById('variants_list').innerHTML = `
          <div style="text-align: center; padding: 3rem; color: #ef4444;">
            <i class="fa-solid fa-exclamation-triangle" style="font-size: 3rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
            <p>Error loading variants. Please try again.</p>
          </div>
        `;
      });
    }

    function displayVariants(variants) {
      const variantsList = document.getElementById('variants_list');

      // Update stats
      const totalStock = variants.reduce((sum, v) => sum + v.stock_quantity, 0);
      const activeCount = variants.filter(v => v.is_active).length;
      const lowStockCount = variants.filter(v => v.stock_quantity <= 10).length;

      document.getElementById('total_variants_stat').textContent = variants.length;
      document.getElementById('total_stock_stat').textContent = totalStock;
      document.getElementById('active_variants_stat').textContent = activeCount;
      document.getElementById('low_stock_stat').textContent = lowStockCount;

      if (variants.length === 0) {
        variantsList.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: #64748b;">
            <i class="fa-solid fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
            <p>No variants yet. Click "Add New Variant" above to create your first variant.</p>
          </div>
        `;
        return;
      }

      variantsList.innerHTML = '';

      // Create table view
      const table = document.createElement('table');
      table.className = 'variants-modal-table';
      table.style.cssText = 'width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);';

      table.innerHTML = `
        <thead>
          <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <th style="padding: 1rem; text-align: left; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Attributes</th>
            <th style="padding: 1rem; text-align: left; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">SKU</th>
            <th style="padding: 1rem; text-align: center; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Stock</th>
            <th style="padding: 1rem; text-align: center; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Incoming</th>
            <th style="padding: 1rem; text-align: center; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Price</th>
            <th style="padding: 1rem; text-align: center; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Status</th>
            <th style="padding: 1rem; text-align: center; color: white; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${variants.map((variant, index) => {
            const stockBadgeColor = variant.stock_quantity === 0 ? '#fee2e2' : variant.stock_quantity < 10 ? '#fef3c7' : '#d1fae5';
            const stockTextColor = variant.stock_quantity === 0 ? '#991b1b' : variant.stock_quantity < 10 ? '#92400e' : '#065f46';
            const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
            const pendingTotal = variant.pending_total || 0;

            return `
              <tr style="background: ${rowBg}; border-bottom: 1px solid #e2e8f0; transition: all 0.2s;"
                  onmouseenter="this.style.background='#f1f5f9'"
                  onmouseleave="this.style.background='${rowBg}'">
                <td style="padding: 1rem;">
                  <div style="font-weight: 600; color: #0f172a; font-size: 0.9375rem; margin-bottom: 0.25rem;">
                    ${variant.size} / ${variant.color}
                  </div>
                  ${variant.material ? `<div style="font-size: 0.8125rem; color: #64748b;">${variant.material}</div>` : ''}
                </td>
                <td style="padding: 1rem;">
                  <div style="font-family: monospace; font-size: 0.8125rem; color: #475569; font-weight: 500;">${variant.sku}</div>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <span style="background: ${stockBadgeColor}; color: ${stockTextColor}; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.8125rem; font-weight: 600; display: inline-block; min-width: 60px;">
                    ${variant.stock_quantity}
                  </span>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  ${pendingTotal > 0 ? `
                    <span
                      onclick="showIncomingDetails(${variant.id})"
                      style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; padding: 0.375rem 0.75rem; border-radius: 6px; font-size: 0.8125rem; font-weight: 600; display: inline-block; cursor: pointer; transition: all 0.2s;"
                      onmouseenter="this.style.transform='scale(1.05)'"
                      onmouseleave="this.style.transform='scale(1)'"
                      title="Click to view pending shipments"
                    >
                      +${pendingTotal}
                    </span>
                  ` : `
                    <span style="color: #94a3b8; font-size: 0.8125rem;">-</span>
                  `}
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="display: flex; align-items: center; justify-content: center; gap: 0.375rem;">
                    <span style="font-size: 0.9375rem; font-weight: 600; color: #0f172a;">$${parseFloat(variant.price).toFixed(2)}</span>
                    ${variant.has_custom_price ? `
                      <span style="font-size: 0.625rem; background: #f5f3ff; color: #667eea; padding: 0.125rem 0.375rem; border-radius: 4px; font-weight: 600;">CUSTOM</span>
                    ` : ''}
                  </div>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <span class="badge ${variant.is_active ? 'active' : 'inactive'}" style="cursor: pointer; font-size: 0.75rem;" onclick="toggleVariantActive(${variant.id})">
                    <i class="fa-solid fa-${variant.is_active ? 'check-circle' : 'times-circle'}"></i>
                    ${variant.is_active ? 'Active' : 'Inactive'}
                  </span>
                </td>
                <td style="padding: 1rem; text-align: center;">
                  <div style="display: inline-flex; gap: 0.5rem;">
                    <button
                      onclick="openRestockModal(${variant.id}, '${variant.sku}')"
                      class="btn btn-secondary btn-sm"
                      title="Restock - Add to shipment"
                      style="padding: 0.5rem 0.75rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); color: #065f46; border-color: #a7f3d0;"
                    >
                      <i class="fa-solid fa-truck"></i>
                    </button>
                    <button
                      onclick="editVariant(${variant.id})"
                      class="btn btn-secondary btn-sm"
                      title="Edit"
                      style="padding: 0.5rem 0.75rem;"
                    >
                      <i class="fa-solid fa-edit"></i>
                    </button>
                    <button
                      onclick="deleteVariant(${variant.id})"
                      class="btn btn-secondary btn-sm"
                      style="background: #fee2e2; color: #991b1b; border-color: #fecaca; padding: 0.5rem 0.75rem;"
                      title="Delete"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      `;

      variantsList.appendChild(table);
    }

    function editVariant(variantId) {
      // Find the variant in allVariants
      const variant = allVariants.find(v => v.id === variantId);
      if (!variant) return;

      // Store variant to populate after form loads
      window.pendingVariantEdit = variant;

      // Set basic form fields first
      document.getElementById('edit_variant_id').value = variant.id;
      document.getElementById('variant_form_title').textContent = 'Edit Variant';
      document.getElementById('variant_sku').value = variant.sku;
      document.getElementById('variant_stock').value = variant.stock_quantity;
      document.getElementById('variant_stock_display').textContent = variant.stock_quantity;

      // Set price mode based on whether variant has custom price
      const basePrice = document.getElementById('variants_base_price').value || '0';
      document.getElementById('base_price_display').textContent = '$' + parseFloat(basePrice).toFixed(2);
      document.getElementById('variant_price').value = variant.price;

      if (variant.has_custom_price) {
        selectPriceMode('custom');
      } else {
        selectPriceMode('base');
      }

      // Set cost mode based on whether variant has custom cost
      const baseCost = document.getElementById('variants_base_cost').value || '0';
      document.getElementById('base_cost_display').textContent = '$' + parseFloat(baseCost).toFixed(2);
      document.getElementById('variant_cost').value = variant.cost || baseCost;

      if (variant.has_custom_cost) {
        selectCostMode('custom');
      } else {
        selectCostMode('base');
      }

      // Load images
      variantImages = variant.images || [];
      displayVariantImages();

      // Load custom fields
      const container = document.getElementById('custom_fields_container');
      container.innerHTML = '';
      if (variant.custom_fields && Object.keys(variant.custom_fields).length > 0) {
        Object.entries(variant.custom_fields).forEach(([name, value]) => {
          const fieldDiv = document.createElement('div');
          fieldDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.75rem; align-items: end;';
          fieldDiv.innerHTML = `
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 0.75rem;">Field Name</label>
              <input type="text" class="custom-field-name" value="${name}" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 0.75rem;">Value</label>
              <input type="text" class="custom-field-value" value="${value}" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
            </div>
            <button type="button" onclick="this.parentElement.remove()" class="btn btn-secondary btn-sm" style="background: #fee2e2; color: #991b1b;">
              <i class="fa-solid fa-trash"></i>
            </button>
          `;
          container.appendChild(fieldDiv);
        });
      } else {
        container.innerHTML = '<p style="color: #64748b; font-size: 0.875rem; font-style: italic;">No custom fields added yet.</p>';
      }

      // Display shared product images
      displaySharedImages();

      // Load variant attributes (which creates form fields), then load dropdowns and set values
      loadVariantAttributesForEdit(variant);
      document.getElementById('variantFormModal').classList.add('active');
    }

    function loadVariantAttributesForEdit(variant) {
      const productId = document.getElementById('variants_product_id').value;
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_product_category_attributes',
          'product_id': productId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) return;

        // Build form fields
        const container = document.getElementById('variant_attributes_container');
        let fieldsHTML = '';

        if (data.uses_size) {
          fieldsHTML += `
            <div class="form-group">
              <label for="variant_size">Size *</label>
              <select id="variant_size" required>
                <option value="">Select size...</option>
              </select>
            </div>
          `;
        }

        if (data.uses_color) {
          fieldsHTML += `
            <div class="form-group">
              <label for="variant_color">Color *</label>
              <select id="variant_color" required>
                <option value="">Select color...</option>
              </select>
            </div>
          `;
        }

        if (data.uses_material) {
          fieldsHTML += `
            <div class="form-group">
              <label for="variant_material">Material</label>
              <select id="variant_material">
                <option value="">Select material...</option>
              </select>
            </div>
          `;
        }

        container.innerHTML = fieldsHTML;

        // Now load dropdowns and set values
        loadFormDropdownsAndSetValues(variant);
      });
    }

    function loadFormDropdownsAndSetValues(variant) {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_sizes_colors_materials'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Populate Size dropdown
          const sizeSelect = document.getElementById('variant_size');
          if (sizeSelect) {
            sizeSelect.innerHTML = '<option value="">Select size...</option>';
            data.sizes.forEach(size => {
              const option = document.createElement('option');
              option.value = size.id;
              option.textContent = size.label;
              sizeSelect.appendChild(option);
            });
            sizeSelect.value = variant.size_id;
          }

          // Populate Color dropdown
          const colorSelect = document.getElementById('variant_color');
          if (colorSelect) {
            colorSelect.innerHTML = '<option value="">Select color...</option>';
            data.colors.forEach(color => {
              const option = document.createElement('option');
              option.value = color.id;
              option.textContent = color.name;
              colorSelect.appendChild(option);
            });
            colorSelect.value = variant.color_id;
          }

          // Populate Material dropdown
          const materialSelect = document.getElementById('variant_material');
          if (materialSelect && data.materials) {
            materialSelect.innerHTML = '<option value="">Select material...</option>';
            data.materials.forEach(material => {
              const option = document.createElement('option');
              option.value = material.id;
              option.textContent = material.name;
              materialSelect.appendChild(option);
            });
            materialSelect.value = variant.material_id || '';
          }
        }
      });
    }

    function addVariant() {
      const productId = document.getElementById('variants_product_id').value;
      const sizeId = document.getElementById('new_variant_size').value;
      const colorId = document.getElementById('new_variant_color').value;
      const stock = 0; // Stock only comes from shipments
      const price = document.getElementById('new_variant_price').value;

      if (!sizeId || !colorId) {
        showToast('Please select both size and color', 'error');
        return;
      }

      if (!price) {
        showToast('Please enter a price', 'error');
        return;
      }

      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'add_variant',
          'product_id': productId,
          'size_id': sizeId,
          'color_id': colorId,
          'stock_quantity': stock,
          'price': price
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reset form
          document.getElementById('new_variant_size').value = '';
          document.getElementById('new_variant_color').value = '';
          document.getElementById('new_variant_price').value = '';

          // Reload variants
          loadVariants(productId);
        } else {
          showToast('Error: ' + (data.error || 'Failed to add variant'), 'error');
        }
      });
    }

    function updateVariantPrice(variantId, newPrice) {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'update_variant_price',
          'variant_id': variantId,
          'price': newPrice
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reload to update custom price indicators
          const productId = document.getElementById('variants_product_id').value;
          loadVariants(productId);
        }
      });
    }

    function toggleVariantActive(variantId) {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'toggle_variant_active',
          'variant_id': variantId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const productId = document.getElementById('variants_product_id').value;
          loadVariants(productId);
        }
      });
    }

    function deleteVariant(variantId) {
      if (!confirm('Are you sure you want to delete this variant?')) {
        return;
      }

      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'delete_variant',
          'variant_id': variantId
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const productId = document.getElementById('variants_product_id').value;
          loadVariants(productId);
        } else {
          showToast('Error: ' + (data.error || 'Failed to delete variant'), 'error');
        }
      });
    }

    // Image handling functions
    function handleVariantImageUpload(event) {
      const files = event.target.files;
      for (let file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
          variantImages.push(e.target.result);
          displayVariantImages();
        };
        reader.readAsDataURL(file);
      }
      // Reset so the same file can be selected again
      event.target.value = '';
    }

    function addImageByURL() {
      const url = prompt('Enter image URL:');
      if (url) {
        variantImages.push(url);
        displayVariantImages();
      }
    }

    let draggedVariantImageIndex = null;

    function displayVariantImages() {
      const container = document.getElementById('variant_images_container');
      container.innerHTML = '';

      if (variantImages.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; font-size: 0.8125rem; font-style: italic;">No variant-specific images. Will use shared product images.</p>';
        return;
      }

      variantImages.forEach((img, index) => {
        // Add /static/ prefix if needed
        const imgSrc = img.startsWith('/') || img.startsWith('http') || img.startsWith('data:') ? img : `/static/${img}`;
        const imgDiv = document.createElement('div');
        imgDiv.draggable = true;
        imgDiv.dataset.index = index;
        imgDiv.style.cssText = 'position: relative; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; cursor: grab; transition: transform 0.15s, border-color 0.15s;';

        // Drag events
        imgDiv.ondragstart = (e) => {
          draggedVariantImageIndex = index;
          imgDiv.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
        };
        imgDiv.ondragend = () => {
          imgDiv.style.opacity = '1';
          draggedVariantImageIndex = null;
          container.querySelectorAll('[data-index]').forEach(el => {
            el.style.borderColor = '#e2e8f0';
            el.style.transform = 'none';
          });
        };
        imgDiv.ondragover = (e) => {
          e.preventDefault();
          if (draggedVariantImageIndex !== null && draggedVariantImageIndex !== index) {
            imgDiv.style.borderColor = '#667eea';
            imgDiv.style.transform = 'scale(1.05)';
          }
        };
        imgDiv.ondragleave = () => {
          imgDiv.style.borderColor = '#e2e8f0';
          imgDiv.style.transform = 'none';
        };
        imgDiv.ondrop = (e) => {
          e.preventDefault();
          if (draggedVariantImageIndex !== null && draggedVariantImageIndex !== index) {
            const draggedImg = variantImages[draggedVariantImageIndex];
            variantImages.splice(draggedVariantImageIndex, 1);
            variantImages.splice(index, 0, draggedImg);
            displayVariantImages();
          }
        };

        imgDiv.innerHTML = `
          <img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="this.src='/static/images/white_bg_top.webp'">
          <div style="position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.6); color: white; border-radius: 4px; width: 20px; height: 20px; font-size: 0.6875rem; display: flex; align-items: center; justify-content: center; font-weight: 600;">${index + 1}</div>
          <button type="button" onclick="event.stopPropagation(); removeVariantImage(${index})" style="position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
            <i class="fa-solid fa-times"></i>
          </button>
        `;
        container.appendChild(imgDiv);
      });

      if (variantImages.length > 1) {
        const helpText = document.createElement('p');
        helpText.style.cssText = 'width: 100%; font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem;';
        helpText.innerHTML = '<i class="fa-solid fa-arrows-up-down-left-right"></i> Drag to reorder.';
        container.appendChild(helpText);
      }
    }

    function removeVariantImage(index) {
      variantImages.splice(index, 1);
      displayVariantImages();
    }

    function displaySharedImages() {
      const section = document.getElementById('shared_images_section');
      const container = document.getElementById('shared_images_container');

      if (!sharedProductImages || sharedProductImages.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      container.innerHTML = '';

      sharedProductImages.forEach((img, index) => {
        const imgSrc = img.startsWith('/') || img.startsWith('http') || img.startsWith('data:') ? img : `/static/${img}`;
        const imgDiv = document.createElement('div');
        imgDiv.style.cssText = 'position: relative; width: 70px; height: 70px; border-radius: 6px; overflow: hidden; border: 2px solid #e2e8f0; opacity: 0.8;';
        imgDiv.innerHTML = `
          <img src="${imgSrc}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='/static/images/white_bg_top.webp'">
          <div style="position: absolute; top: 2px; left: 2px; background: rgba(0,0,0,0.5); color: white; border-radius: 3px; width: 16px; height: 16px; font-size: 0.5625rem; display: flex; align-items: center; justify-content: center; font-weight: 600;">${index + 1}</div>
        `;
        container.appendChild(imgDiv);
      });
    }

    function copySharedImages() {
      if (!sharedProductImages || sharedProductImages.length === 0) {
        showToast('No shared product images to copy.', 'error');
        return;
      }
      // Add shared images to variant images (avoiding duplicates)
      sharedProductImages.forEach(img => {
        if (!variantImages.includes(img)) {
          variantImages.push(img);
        }
      });
      displayVariantImages();
    }

    // Custom fields functions
    let customFieldCounter = 0;
    function addCustomField() {
      const container = document.getElementById('custom_fields_container');
      if (container.querySelector('p')) {
        container.innerHTML = '';
      }

      const fieldId = `custom_field_${customFieldCounter++}`;
      const fieldDiv = document.createElement('div');
      fieldDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.75rem; align-items: end;';
      fieldDiv.innerHTML = `
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Field Name</label>
          <input type="text" class="custom-field-name" placeholder="e.g. Weight" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Value</label>
          <input type="text" class="custom-field-value" placeholder="e.g. 8 oz" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="btn btn-secondary btn-sm" style="background: #fee2e2; color: #991b1b;">
          <i class="fa-solid fa-trash"></i>
        </button>
      `;
      container.appendChild(fieldDiv);
    }

    function addSavedField(key, label) {
      const container = document.getElementById('custom_fields_container');
      if (container.querySelector('p')) {
        container.innerHTML = '';
      }

      const fieldDiv = document.createElement('div');
      fieldDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr auto; gap: 0.5rem; margin-bottom: 0.75rem; align-items: end;';
      fieldDiv.innerHTML = `
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Field Name</label>
          <input type="text" class="custom-field-name" value="${label}" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label style="font-size: 0.75rem;">Value</label>
          <input type="text" class="custom-field-value" placeholder="Enter value..." style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem;">
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="btn btn-secondary btn-sm" style="background: #fee2e2; color: #991b1b;">
          <i class="fa-solid fa-trash"></i>
        </button>
      `;
      container.appendChild(fieldDiv);
    }

    // Filter and sort functions
    function filterVariants() {
      const searchTerm = document.getElementById('search_variants').value.toLowerCase();
      const filterSize = document.getElementById('filter_size').value;
      const filterColor = document.getElementById('filter_color').value;
      const filterMaterial = document.getElementById('filter_material').value;
      const filterStatus = document.getElementById('filter_status').value;

      const filtered = allVariants.filter(v => {
        const matchesSearch = !searchTerm ||
          v.sku.toLowerCase().includes(searchTerm) ||
          v.size.toLowerCase().includes(searchTerm) ||
          v.color.toLowerCase().includes(searchTerm) ||
          (v.material && v.material.toLowerCase().includes(searchTerm));

        const matchesSize = !filterSize || v.size === filterSize;
        const matchesColor = !filterColor || v.color === filterColor;
        const matchesMaterial = !filterMaterial || v.material === filterMaterial;

        let matchesStatus = true;
        if (filterStatus === 'active') matchesStatus = v.is_active;
        if (filterStatus === 'inactive') matchesStatus = !v.is_active;
        if (filterStatus === 'in_stock') matchesStatus = v.stock_quantity > 10;
        if (filterStatus === 'low_stock') matchesStatus = v.stock_quantity > 0 && v.stock_quantity <= 10;
        if (filterStatus === 'out_of_stock') matchesStatus = v.stock_quantity === 0;

        return matchesSearch && matchesSize && matchesColor && matchesMaterial && matchesStatus;
      });

      displayVariants(filtered);
    }

    function sortVariants() {
      const sortBy = document.getElementById('sort_variants').value;

      allVariants.sort((a, b) => {
        switch (sortBy) {
          case 'name':
            return `${a.size}-${a.color}`.localeCompare(`${b.size}-${b.color}`);
          case 'name_desc':
            return `${b.size}-${b.color}`.localeCompare(`${a.size}-${a.color}`);
          case 'price_asc':
            return parseFloat(a.price) - parseFloat(b.price);
          case 'price_desc':
            return parseFloat(b.price) - parseFloat(a.price);
          case 'stock_asc':
            return a.stock_quantity - b.stock_quantity;
          case 'stock_desc':
            return b.stock_quantity - a.stock_quantity;
          case 'created':
            return b.id - a.id;
          default:
            return 0;
        }
      });

      filterVariants(); // Apply current filters after sorting
    }

    // Save variant function
    function saveVariant() {
      const variantId = document.getElementById('edit_variant_id')?.value || '';
      const productId = document.getElementById('variants_product_id')?.value || '';
      const sizeId = document.getElementById('variant_size')?.value || '';
      const colorId = document.getElementById('variant_color')?.value || '';
      const materialId = document.getElementById('variant_material')?.value || '';
      const sku = document.getElementById('variant_sku')?.value || '';
      const stock = document.getElementById('variant_stock')?.value || '0';
      const price = document.getElementById('variant_price')?.value || '';
      const costInput = document.getElementById('variant_cost');
      const cost = costInput ? costInput.value : '';
      const costModeBase = document.getElementById('cost_mode_base');
      const useBaseCost = costModeBase ? costModeBase.checked : true;

      if (!sizeId || !colorId) {
        showToast('Please select both size and color', 'error');
        return;
      }

      if (!price) {
        showToast('Please enter a price', 'error');
        return;
      }

      // Collect custom fields
      const customFields = {};
      document.querySelectorAll('#custom_fields_container > div').forEach(div => {
        const nameEl = div.querySelector('.custom-field-name');
        const valueEl = div.querySelector('.custom-field-value');
        if (nameEl && valueEl && nameEl.value && valueEl.value) {
          customFields[nameEl.value] = valueEl.value;
        }
      });

      const csrftoken = getCookie('csrftoken');

      const formData = new URLSearchParams({
        'action': variantId ? 'update_variant' : 'add_variant',
        'product_id': productId,
        'size_id': sizeId,
        'color_id': colorId,
        'material_id': materialId || '',
        'sku': sku,
        'stock_quantity': stock,
        'price': price,
        'cost': cost || '',
        'use_base_cost': useBaseCost ? 'true' : 'false',
        'images': JSON.stringify(variantImages),
        'custom_fields': JSON.stringify(customFields)
      });

      if (variantId) {
        formData.append('variant_id', variantId);
      }

      // Show saving state
      const saveBtn = document.querySelector('#variantFormModal .btn-primary');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          closeVariantForm();
          // Clear cached variants so they reload fresh
          delete loadedVariants[productId];
          loadVariantsForProduct(productId);
        } else {
          showToast('Error: ' + (data.error || 'Failed to save variant'), 'error');
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalText;
        }
      })
      .catch(error => {
        showToast('Error saving variant: ' + error.message, 'error');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      });
    }

    // Close variants modal on overlay click
    document.getElementById('variantsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeVariantsModal();
      }
    });

    // Close variant form modal on overlay click
    document.getElementById('variantFormModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeVariantForm();
      }
    });

    // ============================================
    // RESTOCK / SHIPMENT FUNCTIONS
    // ============================================
    let currentRestockVariantId = null;
    let currentRestockVariantSku = null;
    let pendingShipmentsList = [];

    function openRestockModal(variantId, sku) {
      currentRestockVariantId = variantId;
      currentRestockVariantSku = sku;

      // Update modal title with SKU
      document.getElementById('restock_variant_sku').textContent = sku;

      // Find variant in allVariants to get cost info
      const variant = allVariants.find(v => v.id === variantId);

      // Reset form
      document.getElementById('restock_quantity').value = '';
      document.getElementById('restock_shipment_select').value = '';
      document.getElementById('quick_shipment_form').style.display = 'none';
      document.getElementById('quick_supplier').value = '';
      document.getElementById('quick_tracking').value = '';

      // Pre-populate cost from variant (already includes product base_cost fallback)
      const variantCost = variant ? parseFloat(variant.cost || 0) : 0;
      document.getElementById('restock_unit_cost').value = variantCost > 0 ? variantCost : '';

      displayCurrentPending(variant);

      // Load available shipments
      loadPendingShipments();

      document.getElementById('restockModal').classList.add('active');
    }

    function closeRestockModal() {
      document.getElementById('restockModal').classList.remove('active');
      currentRestockVariantId = null;
      currentRestockVariantSku = null;
    }

    function loadPendingShipments() {
      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'get_pending_shipments'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          pendingShipmentsList = data.shipments;
          const select = document.getElementById('restock_shipment_select');
          select.innerHTML = '<option value="">Select a shipment...</option>';

          data.shipments.forEach(shipment => {
            const option = document.createElement('option');
            option.value = shipment.id;
            const statusEmoji = shipment.status === 'pending' ? 'üì¶' : shipment.status === 'in-transit' ? 'üöö' : '‚è≥';
            const displayName = shipment.name || shipment.tracking_number;
            option.textContent = `${statusEmoji} ${displayName} - ${shipment.supplier} (${shipment.item_count} items)`;
            select.appendChild(option);
          });

          // Add "Create new" option
          const newOption = document.createElement('option');
          newOption.value = 'new';
          newOption.textContent = '‚ûï Create new shipment...';
          newOption.style.fontWeight = '600';
          select.appendChild(newOption);
        }
      });
    }

    function onShipmentSelectChange() {
      const select = document.getElementById('restock_shipment_select');
      const quickForm = document.getElementById('quick_shipment_form');

      if (select.value === 'new') {
        quickForm.style.display = 'block';
      } else {
        quickForm.style.display = 'none';
      }
    }

    function toggleQuickShipmentForm() {
      const form = document.getElementById('quick_shipment_form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    async function createQuickShipment() {
      const supplier = document.getElementById('quick_supplier').value.trim();
      const tracking = document.getElementById('quick_tracking').value.trim();

      if (!supplier) {
        showToast('Please enter a supplier name', 'error');
        return null;
      }

      const csrftoken = getCookie('csrftoken');

      try {
        const response = await fetch(window.location.pathname, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
          },
          body: new URLSearchParams({
            'action': 'quick_create_shipment',
            'supplier': supplier,
            'tracking_number': tracking
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast('Shipment created');
          return data.shipment.id;
        } else {
          showToast(data.error || 'Failed to create shipment', 'error');
          return null;
        }
      } catch (error) {
        showToast('Failed to create shipment', 'error');
        return null;
      }
    }

    async function submitRestock() {
      const select = document.getElementById('restock_shipment_select');
      let shipmentId = select.value;
      const quantity = document.getElementById('restock_quantity').value;
      const unitCost = document.getElementById('restock_unit_cost').value;

      if (!quantity || parseInt(quantity) <= 0) {
        showToast('Please enter a valid quantity', 'error');
        return;
      }

      // If "new" selected, create shipment first
      if (shipmentId === 'new') {
        shipmentId = await createQuickShipment();
        if (!shipmentId) return;
      }

      if (!shipmentId) {
        showToast('Please select a shipment', 'error');
        return;
      }

      const csrftoken = getCookie('csrftoken');

      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
        },
        body: new URLSearchParams({
          'action': 'add_variant_to_shipment',
          'shipment_id': shipmentId,
          'variant_id': currentRestockVariantId,
          'quantity': quantity,
          'unit_cost': unitCost || '0'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          closeRestockModal();
          showToast(`Added ${quantity} units to shipment`);
          // Reload variants to update incoming counts
          const productId = document.getElementById('variants_product_id').value;
          if (productId) {
            loadVariants(productId);
          }
        } else {
          showToast(data.error || 'Failed to add to shipment', 'error');
        }
      })
      .catch(error => {
        showToast('Error adding to shipment', 'error');
      });
    }

    function displayCurrentPending(variant) {
      const container = document.getElementById('restock_current_pending');

      if (!variant || !variant.pending_shipments || variant.pending_shipments.length === 0) {
        container.innerHTML = '<p style="color: #64748b; font-size: 0.875rem; font-style: italic;">No pending shipments for this variant.</p>';
        return;
      }

      let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
      variant.pending_shipments.forEach(item => {
        const statusColors = {
          'pending': { bg: '#fef3c7', text: '#92400e' },
          'in-transit': { bg: '#dbeafe', text: '#1e40af' },
          'delayed': { bg: '#fee2e2', text: '#991b1b' }
        };
        const colors = statusColors[item.status] || { bg: '#f1f5f9', text: '#64748b' };
        const displayName = item.name || item.tracking;

        html += `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: ${colors.bg}; border-radius: 8px;">
            <div>
              <div style="font-weight: 600; color: ${colors.text}; font-size: 0.875rem;">${displayName}</div>
              ${item.name ? `<div style="font-size: 0.7rem; color: #94a3b8; font-family: monospace;">${item.tracking}</div>` : ''}
              <div style="font-size: 0.75rem; color: #64748b;">${item.supplier}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; color: ${colors.text};">+${item.quantity}</div>
              <div style="font-size: 0.75rem; color: #64748b;">${item.expected_date || 'No date'}</div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      container.innerHTML = html;
    }

    function showIncomingDetails(variantId) {
      const variant = allVariants.find(v => v.id === variantId);
      if (!variant || !variant.pending_shipments || variant.pending_shipments.length === 0) {
        return;
      }

      document.getElementById('incoming_variant_sku').textContent = variant.sku;

      let html = '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
      variant.pending_shipments.forEach(item => {
        const statusColors = {
          'pending': { bg: '#fef3c7', text: '#92400e', icon: 'clock' },
          'in-transit': { bg: '#dbeafe', text: '#1e40af', icon: 'truck' },
          'delayed': { bg: '#fee2e2', text: '#991b1b', icon: 'exclamation-triangle' }
        };
        const colors = statusColors[item.status] || { bg: '#f1f5f9', text: '#64748b', icon: 'box' };

        html += `
          <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: ${colors.bg}; border-radius: 10px; border: 1px solid ${colors.text}20;">
            <div style="width: 40px; height: 40px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
              <i class="fa-solid fa-${colors.icon}" style="color: ${colors.text}; font-size: 1rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: ${colors.text}; font-size: 0.9375rem; margin-bottom: 0.25rem;">${item.tracking}</div>
              <div style="font-size: 0.8125rem; color: #64748b;">${item.supplier}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; font-size: 1.25rem; color: ${colors.text};">+${item.quantity}</div>
              <div style="font-size: 0.75rem; color: #64748b;">
                ${item.expected_date ? `ETA: ${new Date(item.expected_date).toLocaleDateString()}` : 'No ETA'}
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';

      document.getElementById('incoming_details_list').innerHTML = html;
      document.getElementById('incoming_total_count').textContent = variant.pending_total;

      document.getElementById('incomingDetailsModal').classList.add('active');
    }

    function closeIncomingDetailsModal() {
      document.getElementById('incomingDetailsModal').classList.remove('active');
    }

    // Close restock modal on overlay click
    document.getElementById('restockModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeRestockModal();
      }
    });

    // Close incoming details modal on overlay click
    document.getElementById('incomingDetailsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeIncomingDetailsModal();
      }
    });
  </script>

  <!-- Add Product Popup -->
  <div class="popup-overlay" id="add-product-overlay"></div>
  <div class="add-product-popup" id="add-product-popup">
    <div class="popup-header">
      <h3 style="font-size: 1.5rem; font-weight: 700; color: #111827;">Add New Product</h3>
      <button onclick="closeAddProductPopup()" style="background: none; border: none; font-size: 1.5rem; color: #9ca3af; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <form id="add-product-form" method="POST" style="padding: 2rem;">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_product">
      <input type="hidden" name="is_active" value="true">

      <div class="form-group">
        <label for="add_name">Product Name <span style="color: #ef4444;">*</span></label>
        <input type="text" id="add_name" name="name" class="form-input" placeholder="e.g., Classic T-Shirt" required>
      </div>

      <div class="form-group">
        <label for="add_slug">URL Slug <span style="color: #ef4444;">*</span></label>
        <input type="text" id="add_slug" name="slug" class="form-input" placeholder="e.g., classic-tshirt" required>
        <small style="color: #64748b; font-size: 0.8125rem; display: block; margin-top: 0.25rem;">
          Used in product URLs (e.g., /products/<strong>classic-tee</strong>). Auto-generated from name if left empty.
        </small>
      </div>

      <div class="form-group">
        <label for="add_category">Category</label>
        <select id="add_category" name="category" class="form-input">
          <option value="">Uncategorized</option>
          {% for category in categories %}
          <option value="{{ category.slug }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="add_description">Description</label>
        <textarea id="add_description" name="description" class="form-input" rows="4" placeholder="Enter product description..."></textarea>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="add_base_price">Base Price ($) <span style="color: #ef4444;">*</span></label>
          <input type="number" id="add_base_price" name="base_price" class="form-input" step="1" min="0" placeholder="0.00" required>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label for="add_base_cost">Base Cost ($)</label>
          <input type="number" id="add_base_cost" name="base_cost" class="form-input" step="1" min="0" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="add_featured" name="featured" style="width: auto; cursor: pointer;">
          <span>Feature on homepage</span>
        </label>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="add_available" name="available_for_purchase" style="width: auto; cursor: pointer;" checked>
          <span>Available for purchase</span>
        </label>
        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; margin-left: 1.5rem;">If unchecked, product shows "Not Available" instead of Add to Cart</p>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f1f5f9;">
        <button type="button" onclick="closeAddProductPopup()" class="btn" style="flex: 1; background: #f1f5f9; color: #64748b;">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" style="flex: 2;">
          <i class="fa-solid fa-plus"></i> Create Product
        </button>
      </div>
    </form>
  </div>

  <style>
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
    }

    .popup-overlay.active {
      display: block;
    }

    .add-product-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .add-product-popup.active {
      display: block;
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f1f5f9;
    }

    .popup-header button:hover {
      background: #f1f5f9;
      color: #111827;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
  </style>

  <script>
    function openAddProductPopup() {
      document.getElementById('add-product-overlay').classList.add('active');
      document.getElementById('add-product-popup').classList.add('active');
      // Auto-generate slug from name
      document.getElementById('add_name').addEventListener('input', function() {
        if (!document.getElementById('add_slug').value) {
          const slug = this.value.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
          document.getElementById('add_slug').value = slug;
        }
      });
    }

    function closeAddProductPopup() {
      document.getElementById('add-product-overlay').classList.remove('active');
      document.getElementById('add-product-popup').classList.remove('active');
      document.getElementById('add-product-form').reset();
    }

    // Close popup when clicking overlay
    document.getElementById('add-product-overlay').addEventListener('click', closeAddProductPopup);

    // Handle form submission via AJAX
    document.getElementById('add-product-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const form = this;
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';

      fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success notification
          showNotification('Product created successfully!', 'success');
          closeAddProductPopup();
          // Reload the page to show the new product
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          showNotification(data.error || 'Failed to create product', 'error');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      })
      .catch(error => {
        showNotification('An error occurred. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
    });

    // Notification helper
    function showNotification(message, type) {
      // Remove existing notification
      const existing = document.querySelector('.notification-toast');
      if (existing) existing.remove();

      const notification = document.createElement('div');
      notification.className = 'notification-toast';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      notification.innerHTML = `
        <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        ${message}
      `;
      document.body.appendChild(notification);

      // Auto-remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  </script>
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</body>
</html>
