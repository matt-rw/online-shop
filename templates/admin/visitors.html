{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visitors - Blueprint Apparel</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'admin-favicon.svg' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    {% include "admin/partials/dark_mode_styles.html" %}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .nav-links {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      padding: 1rem 2rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .nav-link {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .top-bar {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      padding: 2rem 0;
      box-shadow: 0 4px 20px rgba(6, 182, 212, 0.15);
      margin-bottom: 2rem;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .main-content {
      padding: 0 2rem 2rem 2rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
      margin-top: -4rem;
      position: relative;
      z-index: 10;
    }

    .stat-box {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      text-align: center;
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #06b6d4, #0891b2);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-box:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }

    .stat-box:hover::before {
      opacity: 1;
    }

    .stat-box h4 {
      color: #64748b;
      font-size: 0.8125rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.75rem;
    }

    .stat-box .number {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .stat-box .icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #06b6d4;
    }

    .chart-section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .section-title {
      color: #1e293b;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0;
      position: relative;
      padding-left: 1rem;
    }

    .section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 28px;
      background: linear-gradient(180deg, #06b6d4, #0891b2);
      border-radius: 2px;
    }

    .timeframe-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .timeframe-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }

    .timeframe-btn:hover {
      background: #f8fafc;
      border-color: #06b6d4;
      color: #06b6d4;
    }

    .timeframe-btn.active {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      border-color: #06b6d4;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 1200px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e2e8f0;
    }

    .section h2 {
      color: #1e293b;
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      padding-left: 1rem;
      position: relative;
    }

    .section h2::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, #06b6d4, #0891b2);
      border-radius: 2px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s;
    }

    .list-item:hover {
      background: #f8fafc;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item-label {
      font-weight: 600;
      color: #0f172a;
      font-size: 0.9375rem;
    }

    .list-item-count {
      color: #06b6d4;
      font-weight: 700;
      font-size: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f8fafc;
      color: #64748b;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 1rem;
      text-align: left;
      border-bottom: 2px solid #e2e8f0;
    }

    td {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid #f1f5f9;
      color: #334155;
    }

    tbody tr {
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .badge-desktop {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
    }

    .badge-mobile {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    .badge-tablet {
      background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
      color: #92400e;
    }

    .badge-bot {
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      color: #3730a3;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      .quick-stats {
        grid-template-columns: 1fr;
        margin-top: -3rem;
      }
    }

    /* Toggle switch styles */
    .toggle-switch input:checked + span {
      background-color: #10b981 !important;
    }
    .toggle-switch input:checked + span + span {
      transform: translateX(20px) !important;
    }
    .toggle-switch input:focus + span {
      box-shadow: 0 0 1px #10b981;
    }
  </style>
  {% include "admin/partials/dark_mode_apply.html" %}
</head>
<body>
  <div class="nav-links">
    <a href="{% url 'admin_home' %}" class="nav-link">‚Üê Back</a>
  </div>

  <div class="top-bar">
    <div class="container">
      <div class="header">
        <h1>Visitors</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <!-- Bot Filter Toggle -->
          <div style="display: flex; align-items: center; gap: 0.75rem; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 0.625rem 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.2);">
            <label style="color: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fa-solid fa-robot"></i>
              Hide Bots
            </label>
            <label class="toggle-switch" style="position: relative; display: inline-block; width: 44px; height: 24px;">
              <input type="checkbox" id="hideBots" {% if hide_bots %}checked{% endif %} onchange="toggleBotFilter(this.checked)" style="opacity: 0; width: 0; height: 0;">
              <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.3); transition: .3s; border-radius: 24px;"></span>
              <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; transform: {% if hide_bots %}translateX(20px){% else %}translateX(0){% endif %};"></span>
            </label>
          </div>
          {% if bot_stats.total_bots_30d > 0 %}
          <div style="background: rgba(255,255,255,0.1); padding: 0.5rem 0.75rem; border-radius: 8px; color: white; font-size: 0.75rem; display: flex; align-items: center; gap: 1rem;">
            <span>
              <i class="fa-solid fa-shield-halved"></i>
              <span style="font-weight: 600;">{{ bot_stats.total_bots_30d }}</span> bots (30d)
            </span>
            <span style="opacity: 0.7;">|</span>
            <span>
              <i class="fa-solid fa-calendar-day"></i>
              <span style="font-weight: 600;">{{ bot_stats.bots_today }}</span> today
            </span>
            <span style="opacity: 0.7;">|</span>
            <span>
              <span style="font-weight: 600;">{{ bot_stats.bot_session_percent }}%</span> of traffic
            </span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <!-- Bot Filter Banner (shown when hiding bots) -->
    {% if hide_bots and bot_stats.total_bots_30d > 0 %}
    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border: 1px solid #a5b4fc; border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; margin-top: -2rem; position: relative; z-index: 5;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
          <i class="fa-solid fa-robot" style="color: #4338ca; font-size: 1.25rem;"></i>
          <div>
            <div style="color: #3730a3; font-weight: 600; font-size: 0.875rem;">
              Filtering {{ bot_stats.total_bots_30d }} bot sessions ({{ bot_stats.bot_session_percent }}% of traffic)
            </div>
            <div style="color: #5b21b6; font-size: 0.75rem;">
              {{ bot_stats.bot_pageviews_30d }} page views from bots excluded from stats below
            </div>
          </div>
        </div>
        {% if bot_stats.top_bot_agents %}
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
          <span style="color: #4338ca; font-size: 0.75rem; font-weight: 600;">Top bots:</span>
          {% for agent in bot_stats.top_bot_agents|slice:":3" %}
          <span style="background: white; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-family: monospace; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ agent.user_agent }}">
            {{ agent.user_agent|truncatechars:25 }} ({{ agent.count }})
          </span>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-eye"></i></div>
        <h4>Today's Visits</h4>
        <div class="number">{{ stats.visits_today }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-file-lines"></i></div>
        <h4>Page Views Today</h4>
        <div class="number">{{ stats.page_views_today }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-circle-dot"></i></div>
        <h4>Active Sessions</h4>
        <div class="number">{{ stats.active_sessions }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-users"></i></div>
        <h4>Total Visits (30d)</h4>
        <div class="number">{{ stats.visits_30d }}</div>
      </div>
      <div class="stat-box">
        <div class="icon"><i class="fa-solid fa-mobile-screen-button"></i></div>
        <h4>Mobile Traffic</h4>
        <div class="number">{{ stats.mobile_percent|floatformat:0 }}%</div>
      </div>
    </div>

    <!-- Page Views Chart -->
    <div class="chart-section">
      <div class="chart-header">
        <h2 class="section-title">Page Views</h2>
        <div class="timeframe-buttons">
          <button class="timeframe-btn active" onclick="updateChart('7')">7 Days</button>
          <button class="timeframe-btn" onclick="updateChart('30')">30 Days</button>
          <button class="timeframe-btn" onclick="updateChart('90')">90 Days</button>
        </div>
      </div>
      <canvas id="pageViewsChart" height="80"></canvas>
    </div>

    <!-- Session Insights -->
    <div class="section" style="margin-bottom: 2rem;">
      <h2 style="margin-bottom: 1.5rem;">Session Insights</h2>

      <!-- Session Stats -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1.5rem; border-radius: 12px;">
          <div style="color: #1e40af; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">Total Sessions (30d)</div>
          <div style="color: #1e3a8a; font-size: 2rem; font-weight: 800;">{{ session_stats.total_sessions }}</div>
        </div>
        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 1.5rem; border-radius: 12px;">
          <div style="color: #065f46; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">Avg Duration</div>
          <div style="color: #064e3b; font-size: 2rem; font-weight: 800;">{{ session_stats.avg_duration|floatformat:1 }}<span style="font-size: 1rem; margin-left: 0.25rem;">min</span></div>
        </div>
        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 1.5rem; border-radius: 12px;">
          <div style="color: #4338ca; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">Avg Pages/Session</div>
          <div style="color: #3730a3; font-size: 2rem; font-weight: 800;">{{ session_stats.avg_pages|floatformat:1 }}</div>
        </div>
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1.5rem; border-radius: 12px;">
          <div style="color: #92400e; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">Bounce Rate</div>
          <div style="color: #78350f; font-size: 2rem; font-weight: 800;">{{ session_stats.bounce_rate|floatformat:1 }}<span style="font-size: 1rem; margin-left: 0.25rem;">%</span></div>
          <div style="color: #92400e; font-size: 0.7rem; margin-top: 0.5rem; opacity: 0.8;">% of visitors who left after viewing only one page</div>
        </div>
      </div>

      <!-- Recent Sessions (Scrollable) -->
      <h3 style="margin-bottom: 1rem; font-size: 1.125rem; color: #1e293b;">Recent Sessions</h3>
      <div style="max-height: 600px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; background: #f8fafc;">
        {% for session in recent_sessions %}
          <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
              <div style="flex: 1;">
                <div style="font-family: 'Courier New', monospace; color: #64748b; font-size: 0.7rem; margin-bottom: 0.5rem;">
                  {{ session.session_id|truncatechars:16 }}
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                  <span class="badge badge-{{ session.device_type }}" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                    {% if session.device_type == 'desktop' %}<i class="fa-solid fa-desktop"></i>
                    {% elif session.device_type == 'mobile' %}<i class="fa-solid fa-mobile"></i>
                    {% elif session.device_type == 'tablet' %}<i class="fa-solid fa-tablet"></i>
                    {% else %}<i class="fa-solid fa-robot"></i>{% endif %}
                    {{ session.device_type|capfirst }}
                  </span>
                  {% if session.city %}
                    <span class="location-badge" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                      <i class="fa-solid fa-location-dot"></i> {{ session.city }}
                    </span>
                  {% endif %}
                  {% if session.referrer_domain %}
                    <span class="referrer-badge" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">
                      <i class="fa-solid fa-arrow-up-right-from-square"></i> {{ session.referrer_domain }}
                    </span>
                  {% endif %}
                </div>
              </div>
              <div style="color: #06b6d4; font-weight: 700; font-size: 0.9rem;">
                {{ session.duration_minutes|floatformat:1 }} min
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.8125rem; margin-bottom: 0.75rem;">
              <div><span style="color: #64748b; font-weight: 600;">Started:</span> {{ session.first_seen|date:"M d, g:i A" }}</div>
              <div><span style="color: #64748b; font-weight: 600;">Pages:</span> {{ session.page_views }}</div>
              <div style="font-family: 'Courier New', monospace; font-size: 0.75rem;"><span style="color: #64748b; font-weight: 600;">Landing:</span> {{ session.landing_page }}</div>
            </div>

            {% if session.page_journey %}
              <div style="background: #f8fafc; border-radius: 6px; padding: 0.75rem;">
                <div style="color: #64748b; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem;">Journey</div>
                <div style="display: flex; flex-wrap: wrap; gap: 0.375rem; align-items: center;">
                  {% for page in session.page_journey %}
                    <span style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; font-family: 'Courier New', monospace;">{{ page.path }}</span>
                    {% if not forloop.last %}<i class="fa-solid fa-arrow-right" style="color: #cbd5e1; font-size: 0.625rem;"></i>{% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% empty %}
          <div style="text-align: center; padding: 3rem 1rem; color: #64748b;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5;">üîç</div>
            <h3 style="font-size: 1.125rem; margin-bottom: 0.25rem;">No sessions yet</h3>
            <p style="font-size: 0.875rem;">Session data will appear here as visitors browse your site.</p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="two-column">
      <!-- Top Countries -->
      <div class="section">
        <h2>Top Countries</h2>
        {% if top_countries %}
          {% for country in top_countries %}
            <div class="list-item">
              <div class="list-item-label">
                <i class="fa-solid fa-globe" style="color: #06b6d4; margin-right: 0.5rem;"></i>
                {% if country.country_name %}
                  {{ country.country_name }}
                {% else %}
                  Unknown
                {% endif %}
              </div>
              <div class="list-item-count">{{ country.count }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üåç</div>
            <h3>No location data yet</h3>
            <p>Country data will appear here as visitors arrive.</p>
          </div>
        {% endif %}
      </div>

      <!-- Top Cities -->
      <div class="section">
        <h2>Top Cities</h2>
        {% if top_cities %}
          {% for city in top_cities %}
            <div class="list-item">
              <div class="list-item-label">
                <i class="fa-solid fa-location-dot" style="color: #06b6d4; margin-right: 0.5rem;"></i>
                {% if city.city %}
                  {{ city.city }}, {{ city.region }}
                {% else %}
                  Unknown
                {% endif %}
              </div>
              <div class="list-item-count">{{ city.count }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üìç</div>
            <h3>No city data yet</h3>
            <p>City data will appear here as visitors arrive.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="two-column">
      <!-- Top Referrers -->
      <div class="section">
        <h2>Top Referrers</h2>
        {% if top_referrers %}
          {% for referrer in top_referrers %}
            <div class="list-item">
              <div class="list-item-label">
                <i class="fa-solid fa-arrow-up-right-from-square" style="color: #06b6d4; margin-right: 0.5rem;"></i>
                {% if referrer.referrer_domain %}
                  {{ referrer.referrer_domain }}
                {% else %}
                  Direct / None
                {% endif %}
              </div>
              <div class="list-item-count">{{ referrer.count }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">üîó</div>
            <h3>No referrer data yet</h3>
            <p>Referrer sources will appear here as visitors arrive.</p>
          </div>
        {% endif %}
      </div>

      <!-- Device Breakdown -->
      <div class="section">
        <h2>Device Types</h2>
        <div style="max-width: 300px; margin: 0 auto;">
          <canvas id="deviceChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Pages -->
    <div class="section" style="margin-bottom: 2rem;">
      <h2>Most Visited Pages</h2>
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>Views</th>
            <th>Unique Visitors</th>
            <th>Avg Time (ms)</th>
          </tr>
        </thead>
        <tbody>
          {% for page in top_pages %}
            <tr>
              <td><strong style="color: #0f172a;">{{ page.path }}</strong></td>
              <td>{{ page.views }}</td>
              <td>{{ page.unique_visitors }}</td>
              <td>{{ page.avg_time|floatformat:0 }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" style="text-align: center; color: #64748b;">No page data yet</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Recent Visitors -->
    <div class="section">
      <h2>Recent Visitors</h2>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Page</th>
            <th>Location</th>
            <th>Device</th>
            <th>Browser</th>
            <th>Referrer</th>
          </tr>
        </thead>
        <tbody>
          {% for view in recent_views %}
            <tr>
              <td style="color: #64748b; font-size: 0.875rem;">{{ view.viewed_at|date:"M d, g:i A" }}</td>
              <td><strong style="color: #0f172a;">{{ view.path }}</strong></td>
              <td>
                {% if view.city %}
                  {{ view.city }}, {{ view.country }}
                {% elif view.country_name %}
                  {{ view.country_name }}
                {% else %}
                  Unknown
                {% endif %}
              </td>
              <td>
                <span class="badge badge-{{ view.device_type }}">
                  {% if view.device_type == 'desktop' %}
                    <i class="fa-solid fa-desktop"></i>
                  {% elif view.device_type == 'mobile' %}
                    <i class="fa-solid fa-mobile"></i>
                  {% elif view.device_type == 'tablet' %}
                    <i class="fa-solid fa-tablet"></i>
                  {% else %}
                    <i class="fa-solid fa-robot"></i>
                  {% endif %}
                  {{ view.device_type|capfirst }}
                </span>
              </td>
              <td>{{ view.browser }}</td>
              <td>{{ view.referrer_domain|default:"Direct" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="text-align: center; color: #64748b;">No visitors yet</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <script>
    // Page Views Chart Data
    let pageViewsChart = null;
    let currentPeriod = '7';

    const chartData = {
      '7': [
        {% for day in page_views_7d %}
          { date: '{{ day.date }}', count: {{ day.count }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      '30': [
        {% for day in page_views_30d %}
          { date: '{{ day.date }}', count: {{ day.count }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      '90': [
        {% for day in page_views_90d %}
          { date: '{{ day.date }}', count: {{ day.count }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    };

    function initChart() {
      const ctx = document.getElementById('pageViewsChart').getContext('2d');
      const data = chartData[currentPeriod];

      pageViewsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.date),
          datasets: [{
            label: 'Page Views',
            data: data.map(d => d.count),
            borderColor: '#06b6d4',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2,
            pointRadius: 3,
            pointBackgroundColor: '#06b6d4',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: {
                size: 13,
                weight: '600'
              },
              bodyFont: {
                size: 12
              },
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                font: {
                  family: 'Inter',
                  size: 11
                },
                color: '#64748b'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              }
            },
            x: {
              ticks: {
                font: {
                  family: 'Inter',
                  size: 11
                },
                color: '#64748b',
                maxRotation: 45,
                minRotation: 0
              },
              grid: {
                display: false,
                drawBorder: false
              }
            }
          }
        }
      });
    }

    function updateChart(period) {
      currentPeriod = period;

      // Update active button
      document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update chart data
      const data = chartData[period];
      pageViewsChart.data.labels = data.map(d => d.date);
      pageViewsChart.data.datasets[0].data = data.map(d => d.count);
      pageViewsChart.update();
    }

    // Device Chart
    new Chart(document.getElementById('deviceChart'), {
      type: 'doughnut',
      data: {
        labels: {{ device_labels|safe }},
        datasets: [{
          data: {{ device_counts|safe }},
          backgroundColor: [
            '#06b6d4',  // Desktop - Cyan
            '#10b981',  // Mobile - Green
            '#f59e0b',  // Tablet - Orange
            '#8b5cf6'   // Bot - Purple
          ],
          borderWidth: 3,
          borderColor: '#fff',
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        rotation: -20,
        circumference: 340,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: {
                family: 'Inter',
                size: 11,
                weight: '500'
              },
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.85)',
            padding: 12,
            titleFont: {
              size: 13,
              weight: '600'
            },
            bodyFont: {
              size: 12
            },
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return label + ': ' + value + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });

    // Initialize charts on page load
    document.addEventListener('DOMContentLoaded', () => {
      initChart();
    });

    // Bot filter toggle (bots hidden by default)
    function toggleBotFilter(hideBots) {
      const url = new URL(window.location.href);
      if (hideBots) {
        // Hide bots is the default, so remove the param
        url.searchParams.delete('hide_bots');
      } else {
        // Explicitly show bots
        url.searchParams.set('hide_bots', 'false');
      }
      window.location.href = url.toString();
    }
  </script>
</body>
</html>
