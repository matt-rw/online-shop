{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Center - Blueprint Apparel</title>
  <link rel="icon" type="image/svg+xml" href="{% static 'admin-favicon.svg' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    {% include "admin/partials/dark_mode_styles.html" %}
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f1f5f9;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .nav-links {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      padding: 1rem 2rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .nav-link {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .top-bar {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      padding: 2rem 0;
      box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
      margin-bottom: 2rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .header h1 {
      color: white;
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .header p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    .test-mode-badge {
      background: rgba(0, 0, 0, 0.2);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .main-content {
      padding: 0 2rem 2rem 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      margin-bottom: 2rem;
    }

    .section h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .section-description {
      color: #64748b;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #0f172a;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.625rem 0.875rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .action-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
      margin-top: -4rem;
      position: relative;
      z-index: 10;
    }

    .action-card {
      background: white;
      border-radius: 16px;
      padding: 1.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(226, 232, 240, 0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .action-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }

    .action-card h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .action-card p {
      color: #64748b;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
    }

    .orders-table th,
    .orders-table td {
      padding: 0.75rem 1rem;
      text-align: left;
    }

    .orders-table th {
      background: #f8fafc;
      font-size: 0.75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid #e2e8f0;
    }

    .orders-table td {
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.875rem;
      color: #0f172a;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-badge.paid {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.awaiting_payment {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.canceled {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.refunded {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.created {
      background: #e0e7ff;
      color: #3730a3;
    }

    .result-box {
      padding: 1.25rem;
      border-radius: 12px;
      margin-top: 1rem;
      display: none;
    }

    .result-box.success {
      background: #d1fae5;
      border: 1px solid #10b981;
      color: #065f46;
    }

    .result-box.error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    .result-box.info {
      background: #e0e7ff;
      border: 1px solid #6366f1;
      color: #3730a3;
    }

    .stripe-link {
      color: #635bff;
      text-decoration: none;
      font-weight: 500;
    }

    .stripe-link:hover {
      text-decoration: underline;
    }

    .messages-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      max-width: 400px;
    }

    .alert {
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      animation: slideIn 0.3s ease-out;
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .card-info {
      background: #f8fafc;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.8125rem;
      color: #64748b;
    }

    .card-info code {
      background: #e2e8f0;
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8125rem;
      color: #0f172a;
    }

    @media (max-width: 768px) {
      .action-cards {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 1.75rem;
      }
    }
  </style>
  {% include "admin/partials/dark_mode_apply.html" %}
</head>
<body>
  <div class="nav-links">
    <a href="{% url 'admin_home' %}" class="nav-link"><i class="fa-solid fa-arrow-left"></i> Back</a>
    <a href="{% url 'admin_finance' %}" class="nav-link"><i class="fa-solid fa-chart-line"></i> Finance</a>
  </div>

  <div class="top-bar">
    <div class="container">
      <div class="header">
        <div>
          <h1><i class="fa-solid fa-flask"></i> Test Center</h1>
          <p>Test purchases, discounts, and refunds with Stripe test mode</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <a href="{% url 'admin_test_checkout' %}" style="background: white; color: #059669; padding: 0.75rem 1.5rem; border-radius: 10px; text-decoration: none; font-weight: 700; display: inline-flex; align-items: center; gap: 0.5rem;">
            <i class="fa-solid fa-bolt"></i> Test Checkout
          </a>
          <div class="test-mode-badge">
            <i class="fa-solid fa-shield-halved"></i>
            TEST MODE
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
    <div class="messages-container">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="main-content">
    <!-- Action Cards -->
    <div class="action-cards">
      <!-- Test Purchase Card -->
      <div class="action-card">
        <h3><i class="fa-solid fa-credit-card" style="color: #f59e0b;"></i> Test Purchase</h3>
        <p>Create a test order with Stripe PaymentIntent</p>

        <div class="form-grid">
          <div class="form-group">
            <label for="amount">Amount ($)</label>
            <input type="number" id="amount" value="10.00" step="0.01" min="0.50">
          </div>
          <div class="form-group">
            <label for="product">Product (optional)</label>
            <select id="product">
              <option value="">No product</option>
              {% for product in products %}
              <option value="{{ product.id }}">{{ product.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Success Scenarios</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <button class="btn btn-success" onclick="createTestOrder(true, 'pm_card_visa')" style="padding: 0.5rem 1rem;">
              <i class="fa-brands fa-cc-visa"></i> Visa
            </button>
            <button class="btn btn-success" onclick="createTestOrder(true, 'pm_card_mastercard')" style="padding: 0.5rem 1rem;">
              <i class="fa-brands fa-cc-mastercard"></i> Mastercard
            </button>
            <button class="btn btn-success" onclick="createTestOrder(true, 'pm_card_amex')" style="padding: 0.5rem 1rem;">
              <i class="fa-brands fa-cc-amex"></i> Amex
            </button>
          </div>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Failure Scenarios</label>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
            <button class="btn btn-danger" onclick="createTestOrder(true, 'pm_card_chargeDeclined')" style="padding: 0.5rem 1rem;">
              <i class="fa-solid fa-ban"></i> Declined
            </button>
            <button class="btn btn-danger" onclick="createTestOrder(true, 'pm_card_chargeDeclinedInsufficientFunds')" style="padding: 0.5rem 1rem;">
              <i class="fa-solid fa-wallet"></i> Insufficient Funds
            </button>
            <button class="btn btn-danger" onclick="createTestOrder(true, 'pm_card_chargeDeclinedExpiredCard')" style="padding: 0.5rem 1rem;">
              <i class="fa-solid fa-calendar-xmark"></i> Expired
            </button>
            <button class="btn btn-danger" onclick="createTestOrder(true, 'pm_card_chargeDeclinedFraudulent')" style="padding: 0.5rem 1rem;">
              <i class="fa-solid fa-skull"></i> Fraudulent
            </button>
          </div>
        </div>

        <button class="btn btn-secondary" onclick="createTestOrder(false)" style="width: 100%;">
          <i class="fa-solid fa-keyboard"></i> Manual Card Entry
        </button>

        <div id="purchaseResult" class="result-box"></div>
      </div>

      <!-- Test Discount Card -->
      <div class="action-card">
        <h3><i class="fa-solid fa-tag" style="color: #10b981;"></i> Test Discount</h3>
        <p>Test discount code calculations on a mock cart</p>

        <div class="form-grid">
          <div class="form-group">
            <label for="discountCode">Discount Code</label>
            <input type="text" id="discountCode" placeholder="Enter code">
          </div>
          <div class="form-group">
            <label for="cartTotal">Cart Total ($)</label>
            <input type="number" id="cartTotal" value="100.00" step="0.01" min="0">
          </div>
        </div>

        <button class="btn btn-success" onclick="testDiscount()">
          <i class="fa-solid fa-calculator"></i> Apply Discount
        </button>

        <div id="discountResult" class="result-box"></div>

        {% if discounts %}
        <div class="card-info">
          <strong>Active Discount Codes:</strong><br>
          {% for discount in discounts %}
          <code>{{ discount.code }}</code> - {{ discount.name }}<br>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Create Test Product Card -->
      <div class="action-card">
        <h3><i class="fa-solid fa-box" style="color: #8b5cf6;"></i> Test Product</h3>
        <p>Create a test product with variants and inventory</p>

        <div class="form-grid">
          <div class="form-group">
            <label for="testProductName">Product Name</label>
            <input type="text" id="testProductName" value="Test Item" placeholder="Product name">
          </div>
          <div class="form-group">
            <label for="testProductPrice">Price ($)</label>
            <input type="number" id="testProductPrice" value="1.00" step="0.01" min="0.01">
          </div>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
            <input type="checkbox" id="createWithOrder" checked style="width: 16px; height: 16px; accent-color: #8b5cf6;">
            Also create a paid test order
          </label>
        </div>

        <button class="btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; width: 100%;" onclick="createTestProduct()">
          <i class="fa-solid fa-wand-magic-sparkles"></i> Create Test Product
        </button>

        <div id="productResult" class="result-box"></div>

        {% if test_products %}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
          <div class="form-group" style="margin-bottom: 0.5rem;">
            <label for="deleteProductId">Delete Test Product</label>
            <select id="deleteProductId">
              <option value="">Select product...</option>
              {% for p in test_products %}
              <option value="{{ p.id }}">{{ p.name }} ({{ p.slug }})</option>
              {% endfor %}
            </select>
          </div>
          <button class="btn btn-secondary" style="width: 100%;" onclick="deleteTestProduct()">
            <i class="fa-solid fa-trash"></i> Delete
          </button>
        </div>
        {% endif %}
      </div>

      <!-- Test Refund Card -->
      <div class="action-card">
        <h3><i class="fa-solid fa-rotate-left" style="color: #ef4444;"></i> Test Refund</h3>
        <p>Process a refund on a test order</p>

        <div class="form-grid">
          <div class="form-group">
            <label for="refundOrderId">Order ID</label>
            <select id="refundOrderId">
              <option value="">Select test order</option>
              {% for order in test_orders %}
              {% if order.status == 'PAID' %}
              <option value="{{ order.id }}">#{{ order.id }} - ${{ order.total }}</option>
              {% endif %}
              {% endfor %}
            </select>
          </div>
        </div>

        <button class="btn btn-danger" onclick="processRefund()">
          <i class="fa-solid fa-receipt"></i> Process Refund
        </button>

        <div id="refundResult" class="result-box"></div>
      </div>
    </div>

    <!-- Payment Form for completing test orders -->
    <div class="section" id="paymentSection" style="display: none;">
      <h2><i class="fa-solid fa-lock" style="color: #f59e0b;"></i> Complete Test Payment</h2>
      <p class="section-description">Enter test card details to complete the payment</p>

      <div id="payment-element"></div>

      <div style="margin-top: 1.5rem;">
        <button class="btn btn-primary" id="submitPayment" onclick="submitPayment()">
          <i class="fa-solid fa-credit-card"></i> Pay Now
        </button>
        <button class="btn btn-secondary" onclick="cancelPayment()" style="margin-left: 0.5rem;">
          Cancel
        </button>
      </div>

      <div id="paymentResult" class="result-box"></div>
    </div>

    <!-- Recent Test Orders -->
    <div class="section">
      <h2><i class="fa-solid fa-clock-rotate-left" style="color: #64748b;"></i> Recent Test Orders</h2>
      <p class="section-description">Test orders are not included in regular order analytics</p>

      {% if test_orders %}
      <div style="overflow-x: auto;">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th>Stripe</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="testOrdersBody">
            {% for order in test_orders %}
            <tr id="order-row-{{ order.id }}">
              <td><strong>#{{ order.id }}</strong></td>
              <td>${{ order.total }}</td>
              <td>
                <span class="status-badge {{ order.status|lower }}">
                  {{ order.status }}
                </span>
              </td>
              <td>{{ order.created_at|slice:":10" }}</td>
              <td>
                {% if order.stripe_payment_intent_id %}
                <a href="https://dashboard.stripe.com/test/payments/{{ order.stripe_payment_intent_id }}" target="_blank" class="stripe-link">
                  <i class="fa-solid fa-external-link-alt"></i> View
                </a>
                {% else %}
                -
                {% endif %}
              </td>
              <td>
                {% if order.status == 'PAID' %}
                <button class="btn btn-danger" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="processRefundForOrder({{ order.id }})">
                  Refund
                </button>
                {% endif %}
                <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem; margin-left: 0.25rem;" onclick="deleteTestOrder({{ order.id }})">
                  Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div style="text-align: center; padding: 3rem; color: #64748b; background: #f8fafc; border-radius: 12px;">
        <i class="fa-solid fa-flask" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
        <p>No test orders yet.</p>
        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Create a test purchase above to get started.</p>
      </div>
      {% endif %}
    </div>
  </div>

  {% if stripe_publishable_key %}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('{{ stripe_publishable_key }}');
    let elements = null;
    let currentOrderId = null;
    let currentPaymentIntentId = null;

    async function createTestOrder(autoPay = true, paymentMethod = 'pm_card_visa') {
      const amount = document.getElementById('amount').value;
      const productId = document.getElementById('product').value;
      const resultBox = document.getElementById('purchaseResult');

      try {
        const formData = new FormData();
        formData.append('action', 'create_test_order');
        formData.append('amount', amount);
        formData.append('product_id', productId);
        formData.append('auto_pay', autoPay ? 'true' : 'false');
        formData.append('payment_method', paymentMethod);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "admin_test_center" %}', {
          method: 'POST',
          body: formData,
        });

        // Check if response is OK before parsing JSON
        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Server error ${response.status}: ${text.substring(0, 500)}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Expected JSON but got: ${text.substring(0, 500)}`);
        }

        const result = await response.json();

        if (result.success) {
          if (result.auto_paid) {
            // Auto-paid - show success and reload to update order list
            resultBox.className = 'result-box success';
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
              <strong><i class="fa-solid fa-check-circle"></i> ${result.message}</strong><br>
              <a href="https://dashboard.stripe.com/test/payments/${result.payment_intent_id}" target="_blank" class="stripe-link" style="margin-top: 0.5rem; display: inline-block;">
                <i class="fa-solid fa-external-link-alt"></i> View in Stripe
              </a>
            `;
            // Reload after a moment to show updated order list
            setTimeout(() => window.location.reload(), 1500);
          } else {
            // Manual payment needed
            resultBox.className = 'result-box info';
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
              <strong><i class="fa-solid fa-check-circle"></i> Order Created!</strong><br>
              Order #${result.order_id} created.<br>
              <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showPaymentForm('${result.client_secret}', ${result.order_id}, '${result.payment_intent_id}')">
                <i class="fa-solid fa-credit-card"></i> Complete Payment
              </button>
            `;
          }
        } else {
          // Check if this was an expected decline (testing decline scenarios)
          if (result.declined) {
            resultBox.className = 'result-box info';
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<strong><i class="fa-solid fa-ban"></i> Card Declined (Expected)</strong><br>${result.error}`;
          } else {
            resultBox.className = 'result-box error';
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${result.error}`;
          }
        }
      } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${error.message}`;
      }
    }

    function showPaymentForm(clientSecret, orderId, paymentIntentId) {
      currentOrderId = orderId;
      currentPaymentIntentId = paymentIntentId;

      document.getElementById('paymentSection').style.display = 'block';
      document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });

      elements = stripe.elements({ clientSecret });
      const paymentElement = elements.create('payment');
      document.getElementById('payment-element').innerHTML = '';
      paymentElement.mount('#payment-element');
    }

    async function submitPayment() {
      const submitBtn = document.getElementById('submitPayment');
      const resultBox = document.getElementById('paymentResult');

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

      try {
        const { error, paymentIntent } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: window.location.href,
          },
          redirect: 'if_required',
        });

        if (error) {
          resultBox.className = 'result-box error';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Payment Failed:</strong> ${error.message}`;
        } else if (paymentIntent.status === 'succeeded') {
          // Confirm payment on backend
          const formData = new FormData();
          formData.append('action', 'confirm_test_payment');
          formData.append('payment_intent_id', currentPaymentIntentId);
          formData.append('order_id', currentOrderId);
          formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

          const response = await fetch('{% url "admin_test_center" %}', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            resultBox.className = 'result-box success';
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<strong><i class="fa-solid fa-check-circle"></i> Payment Successful!</strong><br>${result.message}`;

            // Reload page to update order list
            setTimeout(() => window.location.reload(), 2000);
          } else {
            resultBox.className = 'result-box error';
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${result.error}`;
          }
        }
      } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${error.message}`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa-solid fa-credit-card"></i> Pay Now';
      }
    }

    function cancelPayment() {
      document.getElementById('paymentSection').style.display = 'none';
      document.getElementById('payment-element').innerHTML = '';
      document.getElementById('paymentResult').style.display = 'none';
      currentOrderId = null;
      currentPaymentIntentId = null;
    }

    async function testDiscount() {
      const code = document.getElementById('discountCode').value;
      const cartTotal = document.getElementById('cartTotal').value;
      const resultBox = document.getElementById('discountResult');

      if (!code) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = '<strong><i class="fa-solid fa-times-circle"></i></strong> Please enter a discount code.';
        return;
      }

      try {
        const formData = new FormData();
        formData.append('action', 'apply_discount');
        formData.append('discount_code', code);
        formData.append('cart_total', cartTotal);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "admin_test_center" %}', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          resultBox.className = 'result-box success';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `
            <strong><i class="fa-solid fa-check-circle"></i> Discount Applied!</strong><br>
            <strong>${result.discount_name}</strong> (${result.discount_display})<br><br>
            Original: <span style="text-decoration: line-through;">$${result.original_total.toFixed(2)}</span><br>
            Discount: -$${result.discount_amount.toFixed(2)}<br>
            <strong style="color: #10b981;">Final: $${result.final_total.toFixed(2)}</strong><br><br>
            <span style="font-size: 0.75rem; color: #64748b;">
              Used ${result.times_used} times${result.max_uses ? ' of ' + result.max_uses + ' max' : ''}
            </span>
          `;
        } else {
          resultBox.className = 'result-box error';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${result.error}`;
        }
      } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${error.message}`;
      }
    }

    async function processRefund() {
      const orderId = document.getElementById('refundOrderId').value;
      const resultBox = document.getElementById('refundResult');

      if (!orderId) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = '<strong><i class="fa-solid fa-times-circle"></i></strong> Please select an order to refund.';
        return;
      }

      await processRefundForOrder(orderId);
    }

    async function processRefundForOrder(orderId) {
      const resultBox = document.getElementById('refundResult');

      if (!confirm('Are you sure you want to refund this order?')) {
        return;
      }

      try {
        const formData = new FormData();
        formData.append('action', 'process_refund');
        formData.append('order_id', orderId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "admin_test_center" %}', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          resultBox.className = 'result-box success';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-check-circle"></i> Refund Processed!</strong><br>${result.message}`;

          // Reload page to update order list
          setTimeout(() => window.location.reload(), 2000);
        } else {
          resultBox.className = 'result-box error';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${result.error}`;
        }
      } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${error.message}`;
      }
    }

    async function deleteTestProduct() {
      const productId = document.getElementById('deleteProductId').value;
      const resultBox = document.getElementById('productResult');

      if (!productId) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = '<strong><i class="fa-solid fa-times-circle"></i></strong> Select a product to delete.';
        return;
      }

      if (!confirm('Delete this test product? This will also remove it from any active carts.')) {
        return;
      }

      try {
        const formData = new FormData();
        formData.append('action', 'delete_test_product');
        formData.append('product_id', productId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "admin_test_center" %}', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          resultBox.className = 'result-box success';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-check-circle"></i></strong> ${result.message}`;
          setTimeout(() => window.location.reload(), 1000);
        } else {
          resultBox.className = 'result-box error';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${result.error}`;
        }
      } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${error.message}`;
      }
    }

    async function createTestProduct() {
      const name = document.getElementById('testProductName').value;
      const price = document.getElementById('testProductPrice').value;
      const createOrder = document.getElementById('createWithOrder').checked;
      const resultBox = document.getElementById('productResult');

      if (!name) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = '<strong><i class="fa-solid fa-times-circle"></i></strong> Please enter a product name.';
        return;
      }

      try {
        const formData = new FormData();
        formData.append('action', 'create_test_product');
        formData.append('name', name);
        formData.append('price', price);
        formData.append('create_order', createOrder ? 'true' : 'false');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "admin_test_center" %}', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          resultBox.className = 'result-box success';
          resultBox.style.display = 'block';
          let html = `<strong><i class="fa-solid fa-check-circle"></i> ${result.message}</strong><br>`;
          html += `Product: ${result.product_name} (ID: ${result.product_id})<br>`;
          html += `Variant SKU: ${result.variant_sku}<br>`;
          if (result.order_id) {
            html += `<br><strong>Test Order #${result.order_id} created!</strong><br>`;
            html += `<a href="{% url 'admin_returns' %}" class="stripe-link" style="color: #8b5cf6;">
              <i class="fa-solid fa-box-archive"></i> Go to Returns Dashboard
            </a>`;
          }
          resultBox.innerHTML = html;

          // Reload after a moment to update dropdowns
          setTimeout(() => window.location.reload(), 2000);
        } else {
          resultBox.className = 'result-box error';
          resultBox.style.display = 'block';
          resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${result.error}`;
        }
      } catch (error) {
        resultBox.className = 'result-box error';
        resultBox.style.display = 'block';
        resultBox.innerHTML = `<strong><i class="fa-solid fa-times-circle"></i> Error:</strong> ${error.message}`;
      }
    }

    async function deleteTestOrder(orderId) {
      if (!confirm('Delete this test order? This cannot be undone.')) {
        return;
      }

      try {
        const formData = new FormData();
        formData.append('action', 'delete_test_order');
        formData.append('order_id', orderId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "admin_test_center" %}', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          // Remove row from table
          const row = document.getElementById('order-row-' + orderId);
          if (row) row.remove();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
  </script>
  {% else %}
  <script>
    function createTestOrder() {
      alert('Stripe test publishable key not configured.');
    }
    function testDiscount() {
      alert('Test discount functionality available.');
    }
    function processRefund() {
      alert('Stripe test keys not configured.');
    }
  </script>
  {% endif %}
</body>
</html>
