{% extends 'base.html' %}
{% load static %}

{% block title %}Cart - Blueprint Apparel{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<div class="border-b border-black">
  <div class="max-w-7xl mx-auto px-6 py-3">
    <nav class="flex items-center text-xs tracking-wider">
      <a href="{% url 'home' %}" class="text-neutral-500 hover:text-black transition-colors uppercase">Home</a>
      <span class="mx-3 text-neutral-300">/</span>
      <span class="text-black uppercase">Cart</span>
    </nav>
  </div>
</div>

<!-- Cart Header -->
<section class="bg-white border-b border-black">
  <div class="max-w-7xl mx-auto px-6 py-8">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs text-neutral-500 uppercase tracking-wider mb-2">Shopping</p>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">YOUR CART</h1>
      </div>
      <span id="cart-count" class="text-xs tracking-widest text-neutral-500">{{ cart_items|length }} ITEM{{ cart_items|length|pluralize:"S" }}</span>
    </div>
  </div>
</section>

<!-- Cart Content -->
<section class="bg-white">
  <div class="max-w-7xl mx-auto">
    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3">

      <!-- Cart Items -->
      <div class="lg:col-span-2 border-r border-black" id="cart-items"
           data-update-url="{% url 'shop:update_cart_item' 0 %}"
           data-remove-url="{% url 'shop:remove_from_cart' 0 %}">
        {% for cart_item in cart_items %}
        <div class="cart-item flex gap-6 p-6 border-b border-black" data-item-id="{{ cart_item.item.id }}" data-price="{{ cart_item.item.variant.price }}">
          <!-- Product Image -->
          <div class="w-28 h-36 bg-neutral-100 flex-shrink-0 border border-black overflow-hidden">
            {% if cart_item.image %}
            <img src="{{ cart_item.image }}" alt="{{ cart_item.item.variant.product.name }}" class="w-full h-full object-cover" />
            {% elif 'pants' in cart_item.item.variant.product.slug|lower or 'bottom' in cart_item.item.variant.product.name|lower %}
            <img src="{% static 'images/white_bg_bottom.webp' %}" alt="{{ cart_item.item.variant.product.name }}" class="w-full h-full object-cover" />
            {% else %}
            <img src="{% static 'images/white_bg_top.webp' %}" alt="{{ cart_item.item.variant.product.name }}" class="w-full h-full object-cover" />
            {% endif %}
          </div>

          <!-- Product Info -->
          <div class="flex-grow flex flex-col justify-between">
            <div>
              <p class="text-xs text-neutral-500 uppercase tracking-wider mb-1">Foundation</p>
              <h3 class="font-bold tracking-tight">"{{ cart_item.item.variant.product.name|upper }}"</h3>
              <p class="text-sm text-neutral-600 mt-1">
                {% if cart_item.item.variant.size %}Size: {{ cart_item.item.variant.size }}{% endif %}
                {% if cart_item.item.variant.size and cart_item.item.variant.color %} | {% endif %}
                {% if cart_item.item.variant.color %}Color: {{ cart_item.item.variant.color }}{% endif %}
              </p>
            </div>
            <p class="text-lg font-bold">${{ cart_item.item.variant.price }}</p>
          </div>

          <!-- Quantity & Remove -->
          <div class="flex flex-col items-end justify-between">
            <!-- Remove Button -->
            <button type="button" onclick="removeItem({{ cart_item.item.id }})" class="text-neutral-400 hover:text-black transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>

            <!-- Quantity Controls -->
            <div class="flex items-center border border-black">
              <button type="button" class="qty-btn minus px-3 py-2 hover:bg-black hover:text-white transition-colors" data-item-id="{{ cart_item.item.id }}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>

              <span class="item-quantity px-4 py-2 border-x border-black text-sm font-medium">{{ cart_item.item.quantity }}</span>

              <button type="button" class="qty-btn plus px-3 py-2 hover:bg-black hover:text-white transition-colors" data-item-id="{{ cart_item.item.id }}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1 p-6 lg:p-8">
        <div class="sticky top-8">
          <span class="text-xs tracking-widest uppercase font-medium block mb-6">Order Summary</span>

          <div class="space-y-4 mb-8">
            <div class="flex justify-between text-sm">
              <span class="text-neutral-600">Subtotal</span>
              <span id="subtotal" class="font-medium">${{ subtotal }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-neutral-600">Shipping</span>
              <span id="shipping" class="font-medium {% if free_shipping %}text-green-600{% else %}text-neutral-400{% endif %}">
                {% if free_shipping %}
                  FREE
                {% else %}
                  Calculated at checkout
                {% endif %}
              </span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-neutral-600">Tax</span>
              <span id="tax" class="font-medium text-neutral-400">Calculated at checkout</span>
            </div>
            <div class="border-t border-black pt-4 flex justify-between">
              <span class="text-xs tracking-widest uppercase font-medium">Total</span>
              <span id="total" class="text-xl font-bold">${{ subtotal }}</span>
            </div>
          </div>

          <a href="{% url 'shop:checkout' %}"
             class="block w-full py-4 bg-black text-white text-center text-xs tracking-widest uppercase font-medium hover:bg-neutral-800 transition-colors mb-4">
            Proceed to Checkout
          </a>

          <!-- Stripe Badge -->
          <div class="flex items-center justify-center gap-2 mb-4">
            <span class="text-xs text-neutral-400">Powered by</span>
            <svg class="h-5 w-auto text-neutral-400" viewBox="0 0 60 25" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a10.5 10.5 0 0 1-4.56 1c-4.01 0-6.83-2.5-6.83-7.48 0-4.19 2.39-7.52 6.3-7.52 3.92 0 5.96 3.28 5.96 7.5 0 .4-.03 1.07-.06 1.58zm-6.03-5.73c-1.08 0-2.09.85-2.21 2.66h4.32c0-1.64-.81-2.66-2.11-2.66zM40.95 20.3c-1.44 0-2.32-.6-2.9-1.04l-.02 4.63-4.12.87V5.57h3.76l.1 1.03a4.32 4.32 0 0 1 3.08-1.25c2.85 0 5.62 2.58 5.62 7.4 0 5.23-2.7 7.55-5.52 7.55zM40 9.23c-.95 0-1.54.34-1.97.81l.02 5.76c.4.42.98.78 1.95.78 1.52 0 2.54-1.65 2.54-3.7 0-2.01-1.02-3.65-2.54-3.65zM28.24 5.57h4.13v14.44h-4.13V5.57zm0-5.13L32.37 0v3.45l-4.13.88V.44zm-4.32 9.35v10.22H19.8V5.57H23l.37 1.5a4.35 4.35 0 0 1 3.74-1.73v3.99c-.3-.05-.77-.06-1.2 0-.73.1-1.52.44-1.99.93v-.47zM13.03 6.98c0-.66.55-1.17 1.64-1.17 1.46 0 3.13.47 4.52 1.28V3.19a11.84 11.84 0 0 0-4.5-.82c-3.66 0-6.08 1.91-6.08 5.09 0 4.95 6.82 4.16 6.82 6.29 0 .79-.68 1.25-1.85 1.25-1.6 0-3.63-.66-5.24-1.55v3.96a12.28 12.28 0 0 0 5.24 1.16c3.77 0 6.34-1.86 6.34-5.08 0-5.33-6.89-4.39-6.89-6.51zM2.59 10.24l-.45 1.95h5.12v-3.5H.01l.02 3.85c0 4.74 2.32 7.76 7.1 7.76.9 0 1.62-.08 2.14-.22v-3.63c-.44.1-.98.16-1.54.16-2.02 0-3.06-1.03-3.12-2.78h4.52V5.57H2.61l-.02 4.67z"/>
            </svg>
          </div>

          <a href="{% url 'shop:shop' %}" class="block text-center text-xs tracking-wider uppercase text-neutral-500 hover:text-black transition-colors">
            Continue Shopping
          </a>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Empty Cart -->
    <div class="py-24 text-center" id="empty-cart">
      <div class="mb-8">
        <svg class="w-16 h-16 mx-auto text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
      </div>
      <p class="text-neutral-500 text-sm mb-8">Your cart is empty</p>
      <a href="{% url 'shop:shop' %}"
         class="inline-block px-8 py-4 bg-black text-white text-xs tracking-widest uppercase font-medium hover:bg-neutral-800 transition-colors">
        Start Shopping
      </a>
    </div>
    {% endif %}
  </div>
</section>

{% if cart_items %}
<!-- Section Divider -->
<div class="border-t border-black">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <span class="text-xs tracking-wider text-neutral-500">Free shipping on orders over $100</span>
    <span class="text-xs tracking-widest uppercase font-medium">Blueprint Apparel</span>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';
const cartItemsEl = document.getElementById('cart-items');
const updateUrlBase = cartItemsEl?.dataset.updateUrl?.replace('/0/', '/{id}/') || '';
const removeUrlBase = cartItemsEl?.dataset.removeUrl?.replace('/0/', '/{id}/') || '';

// Use event delegation for quantity buttons
cartItemsEl?.addEventListener('click', function(e) {
  const btn = e.target.closest('.qty-btn');
  if (!btn) return;

  const itemId = btn.dataset.itemId;
  const itemEl = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
  const qtyEl = itemEl.querySelector('.item-quantity');
  const currentQty = parseInt(qtyEl.textContent);

  if (btn.classList.contains('minus')) {
    updateQuantity(itemId, currentQty - 1);
  } else if (btn.classList.contains('plus')) {
    updateQuantity(itemId, currentQty + 1);
  }
});

async function updateQuantity(itemId, newQuantity) {
  if (newQuantity < 1) {
    removeItem(itemId);
    return;
  }

  const itemEl = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
  const qtyEl = itemEl.querySelector('.item-quantity');
  const oldQty = parseInt(qtyEl.textContent);

  // Optimistic update
  qtyEl.textContent = newQuantity;

  try {
    const response = await fetch(updateUrlBase.replace('{id}', itemId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: `quantity=${newQuantity}`
    });

    const data = await response.json();

    if (data.success) {
      updateTotals(data.cart_total);
      updateCartCount(data.cart_count);
    } else {
      qtyEl.textContent = oldQty;
    }
  } catch (error) {
    console.error('Error updating quantity:', error);
    qtyEl.textContent = oldQty;
  }
}

async function removeItem(itemId) {
  const itemEl = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);

  // Optimistic removal with fade
  itemEl.style.opacity = '0.5';

  try {
    const response = await fetch(removeUrlBase.replace('{id}', itemId), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      }
    });

    const data = await response.json();

    if (data.success) {
      itemEl.remove();
      updateTotals(data.cart_total);
      updateCartCount(data.cart_count);

      // Check if cart is now empty
      if (data.cart_count === 0) {
        location.reload();
      }
    } else {
      itemEl.style.opacity = '1';
    }
  } catch (error) {
    console.error('Error removing item:', error);
    itemEl.style.opacity = '1';
  }
}

function updateTotals(cartTotal) {
  const subtotal = parseFloat(cartTotal);
  // Free shipping on orders $100+, otherwise calculated at checkout
  const freeShipping = subtotal >= 100;
  const shippingEl = document.getElementById('shipping');

  document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);

  if (freeShipping) {
    shippingEl.textContent = 'FREE';
    shippingEl.classList.remove('text-neutral-400');
    shippingEl.classList.add('text-green-600');
    document.getElementById('total').textContent = '$' + subtotal.toFixed(2);
  } else {
    shippingEl.textContent = 'Calculated at checkout';
    shippingEl.classList.remove('text-green-600');
    shippingEl.classList.add('text-neutral-400');
    document.getElementById('total').textContent = '$' + subtotal.toFixed(2);
  }
}

function updateCartCount(count) {
  const countEl = document.getElementById('cart-count');
  countEl.textContent = count + ' ITEM' + (count !== 1 ? 'S' : '');
}
</script>
{% endblock %}
